-- Copyright (C) 1987  by Xerox Corporation. All rights reserved.---- File: DiagFlTapeCmds.mesa-- Edited by: JMA 17-Feb-88 11:50:43-- DIRECTORY FloppyTape		USING	[Drive, VolumeHandle], DiagFlTapeBuff		USING	[dataType], DiagFlTapeCmdDes	USING	[Command], DiagFlTapeErrorCheck	USING	[errorType, expectedStatus], FloppyDiskFace		USING	[Attributes, Context, Operation,				 Status, DeviceHandle]; DiagFlTapeCmds: DEFINITIONS =BEGIN    DiagFlTapeCmdsImpl:	PROGRAM;  IOCommandContext:	TYPE= RECORD[			  floppyTapeContext: FloppyDiskFace.Context,			  steamingMode: BOOLEAN¬ FALSE,			  deviceParms: FloppyDiskFace.Attributes]; IOCmdContext:		IOCommandContext;  IoCPIdx:	CARDINAL; IoCPA:		ARRAY [0..2] OF IoCP;  --the record below to be entered into the error log and trace table. --holds all of the stuff that the IO command needs plus stuff that  --needs to be logged so that the command can be reconstructed in --the same manner as it would look when building a command file. IoCP: TYPE= MACHINE DEPENDENT RECORD [	command(0):			DiagFlTapeCmdDes.Command,	track(1):			CARDINAL¬ 0,	head(2):			CARDINAL¬ 0,	sector(3):			CARDINAL¬ 1,	sectorOrTrackCount(4):		CARDINAL¬ LAST[CARDINAL],	tries(5):		CARDINAL¬ LAST[CARDINAL],	opPtr(6):			LONG POINTER TO FloppyDiskFace.Operation,	--data buffer stuff	data(8):			CARDINAL¬ 0,	dataType(9):			DiagFlTapeBuff.dataType¬ constant,	need0sInRdBuff(10):		BOOLEAN¬ FALSE,	needVrfyData(11):		BOOLEAN¬ FALSE,	--timeout stuff	timeCmdStarted(12):		LONG CARDINAL,	timeOutTime(14):		LONG CARDINAL,	--returned data and status	errorType(16:0..3):		DiagFlTapeErrorCheck.errorType,	cmdTimedOut(16:4..4):		BOOLEAN¬ FALSE,	rtrndSectorCntError(16:5..5):	BOOLEAN¬ FALSE,	rtrndTrackCntError(16:6..6):	BOOLEAN¬ FALSE,	dataVerifyError(16:7..7):	BOOLEAN¬ FALSE,	dataNotWrittenError(16:8..8):	BOOLEAN¬ FALSE,	iDVerifyError(16:9..9):		BOOLEAN¬ FALSE,	writeProtected(16:10..10):	BOOLEAN¬ FALSE,	retensionPassDone(16:11..11):	BOOLEAN¬ FALSE,	spare17(16:12..15):		[0..15],	dataErrorIndex(17):		CARDINAL,	dataErrorExpected(18):		CARDINAL,	dataErrorObserved(19):		CARDINAL,	errorCode(20):			DiagFlTapeErrorCheck.expectedStatus,	fRUCode(21):			CARDINAL,        retriedCount(22):		CARDINAL¬ 0,        rtndStatus(23):			FloppyDiskFace.Status];  CmdTimedOut:		BOOLEAN;			   Sector:		CARDINAL; MinSector:		CARDINAL; MaxSector:		CARDINAL; SectorCount:		CARDINAL; MinSectorCount:	CARDINAL; MaxSectorCount:	CARDINAL; Head:			CARDINAL; -- set to 0 MinHead:		CARDINAL; -- set to 0 MaxHead:		CARDINAL; -- set to 0 Track:			CARDINAL; MinTrack:		CARDINAL; MaxTrack:		CARDINAL; TrackCount:		CARDINAL; MinTrackCount:		CARDINAL; MaxTrackCount:		CARDINAL; Stream:		CARDINAL; MinStream:		CARDINAL; MaxStream:		CARDINAL; WordsPerSector:	CARDINAL;	--[0..255] SectorsPerTrack:	CARDINAL;	--[0..31] SectorsPerStream:	CARDINAL; SectorsPerTape:	LONG CARDINAL; MaxTracksPerFormat:	LONG CARDINAL; TracksPerStream:	CARDINAL;	--[0..244] TracksPerTape:		CARDINAL; StreamsPerTape:	CARDINAL;	--[1..12]  --device handle DeviceHandle:		FloppyDiskFace.DeviceHandle; CurrentTestDrive:	FloppyTape.Drive;  WriteBuffPtr1:		LONG POINTER TO ARRAY OF WORD; WriteBuffPtr2:		LONG POINTER TO ARRAY OF WORD; ReadBuffPtr1:		LONG POINTER TO ARRAY OF WORD; ReadBuffPtr2:		LONG POINTER TO ARRAY OF WORD; ReadIDBuffPtr1:	LONG POINTER TO ARRAY OF WORD; ReadIDBuffPtr2:	LONG POINTER TO ARRAY OF WORD; WrBuffArray:		ARRAY [0..1] OF LONG POINTER TO ARRAY OF WORD; RdBuffArray:		ARRAY [0..1] OF LONG POINTER TO ARRAY OF WORD; RdIDBuffArray:		ARRAY [0..1] OF LONG POINTER TO ARRAY OF WORD; LastReadSize:		CARDINAL; --used for read buffer display LastReadCmdIdx:	CARDINAL; --used for read buffer display LastWriteSize:		CARDINAL; --used for write buffer display LastWriteCmdIdx:	CARDINAL; --used for write buffer display IDBuffHasData:		BOOLEAN;  --used for read ID buffer display LastReadIDCmdIdx:	CARDINAL; --used for read ID buffer display StatusHasData:		BOOLEAN;  --used for status display LastReadStatus:	FloppyDiskFace.Status; --used for status display  -- global volume type stuff ValidVolumeHandle:	BOOLEAN; VolumeHandle:		FloppyTape.VolumeHandle;  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- initialize the IO command stuff -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  InitCmdStuff: PROCEDURE []; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- resets the floppy controller -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  ResetController: PROCEDURE []; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- clears the Disk Change status bit in the floppy controller -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  ClearDiskChange: PROCEDURE []; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- go to track 0 -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  Recalibrate: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- retensions the tape -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  Retention: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- retensions the tape when other error has occured -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  RetentionFromErrCheck: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- issues a seek command -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  Seek: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- does nothing but returns controller status -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  NoOp: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- read ID -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  ReadID: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- sets read header in disk command -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  ReadSector: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- write sectors -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  WriteSector: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- write deleted sector -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  WriteDelSector: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- formats the given number of tracks -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  FormatTrack: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- Reads th entire track -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  ReadTrack: PROCEDURE; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- This procedure waits for the completion of the IO command -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  WaitForCompletion: PROCEDURE [index: CARDINAL¬ 0]; -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -- set up the IO command pointers to point to the right stuff -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  ExecuteCmd: PROCEDURE [ioCP: CARDINAL¬ 0];  END... --of DiagFlTapeCmds.mesaLOG15-Nov-86  8:55:0217-Feb-88 11:50:57 JMA: added MaxTracksPerFormat and CurrentTestDrive.   