<<	Copyright (C) 1984, 1985, 1986, 1987, 1989 by Xerox Corporation and Fuji Xerox.  All rights reserved.	File = FloppyIOFaceDove.mesa	Stored as [B]<WFaces>Dove>FloppyIOFaceDove.mesa	Written for Dove>>-- Last edit by:-- MS	20-Jan-89 10:12:44	change sa475FormatInfoTable-- JAC	16-Nov-87 11:11:08	add savedStatus in IOCB-- JAC	13-Oct-87 17:41:07	semaphore must be a word-- JAC	26-Sep-87 17:07:37	add fillerByteForTapeFormatting-- JAC	25-Sep-87  9:41:15	add semaphore and swith FloppyDiagnosticsOn and FloppyTapeThisIOCB-- JAC	22-Sep-87 17:35:57	change FloppyExtraWord to FloppyDiagnosticsOn in FCB-- JAC	 5-Aug-87 19:41:17	change comments on DriveStatusHead0-- JAC	17-Jul-87 19:14:56	correct EncodedDiskDriveType-- JAC	 6-Jul-87 16:09:57	add handler changes to FunctionContextBlock-- JAC	25-Jun-87 17:29:55	for floppy tapeDIRECTORY  Device USING [ nullType ],  DoveInputOutput USING [ ClientCondition, IOPCondition, NotifyMask, OpieAddress, QueueBlock, TaskContextBlock ],  FloppyDiskFace USING [ Attributes, Context, Density, DiskAddress, Function, Operation, Status, Tries],  Environment USING [ Byte ] ;  FloppyIOFaceDove : DEFINITIONS =BEGIN  Bit : TYPE = [0..1] ;  CounterControlWord : TYPE = MACHINE DEPENDENT RECORD   [    Enable(0:0..0) : BOOLEAN,    ChangeEnable(0:1..1) : BOOLEAN,    CounterInterruptWhenDone(0:2..2) : BOOLEAN,    RegisterInUse(0:3..3) : BOOLEAN,    NotUsed11(0:4..4) : BOOLEAN,    NotUsed10(0:5..5) : BOOLEAN,    NotUsed9(0:6..6) : BOOLEAN,    NotUsed8(0:7..7) : BOOLEAN,    NotUsed7(0:8..8) : BOOLEAN,    NotUsed6(0:9..9) : BOOLEAN,    MaximumCount(0:10..10) : BOOLEAN,    Retrigger(0:11..11) : BOOLEAN,    Prescaler(0:12..12) : BOOLEAN,    External(0:13..13) : BOOLEAN,    Alternate(0:14..14) : BOOLEAN,    Continuous(0:15..15) : BOOLEAN  ] ;  DataTransferOperation : ARRAY fdcCommandType OF DataTransferType =  [    None,	--  NullCommand    Write,	--  FormatTrack    Read,	--  ReadData    Read,	--  ReadDeletedData    None,	--  ReadID    Read,	--  ReadTrack    None,	--  Recalibrate    Write,	--  ScanEqual    Write,	--  ScanHighOrEqual    Write,	--  ScanLowOrEqual    None,	--  Seek    None,	--  SenseDriveStatus    None,	--  SenseInterruptStatus    None,	--  Specify    Write,	--  WriteData    Write	--  WriteDeletedData  ] ;  DataTransferType : TYPE = MACHINE DEPENDENT { None(0), Read(1), Write(2), (255) } ;  DefaultContext : FloppyDiskFace.Context =  [    protect : FALSE,    format : IBM,    density : double,    sectorLength : 256  ] ;  DeviceContextBlock : TYPE = MACHINE DEPENDENT RECORD  [    DeviceAttributes(0:0..79) : FloppyDiskFace.Attributes,	-- only used by Head    dcbExtraByte1(5:0..7) : Environment.Byte,    DriveBusy(5:8..15) : BOOLEAN,				-- set by Handler, read by Head    DiagnosticDiskChanged(6) : BOOLEAN,				-- set by Handler, cleared and/or read by Head    PilotDiskChanged(7) : BOOLEAN,				-- set by Handler, cleared and/or read by Head    DiagnosticContext(8) : FloppyDiskFace.Context,		-- only used by Head    PilotContext(9) : FloppyDiskFace.Context,			-- only used by Head    DoorOpen(10) : BOOLEAN,					-- set by Handler, read by Head    DriveStatusHead0(11:0..7) : fdcStatusRegister3Type,	-- set by Handler, read by Head if floppy.  head sets this if tape.    SpecifyAndRecalFlags(11:8..15) : Environment.Byte,    Port80ControlWord(12) : Port80ControlWordRecord,    StepRateTimePlusHeadUnloadTime(13:0..7) : Environment.Byte,    HeadLoadTimePlusNotInDMAmode(13:8..15) : Environment.Byte  ] ;  dmaControlWord : TYPE = MACHINE DEPENDENT RECORD   [    IOorMemoryDestination(0:0..0) : { io, memory },    DecrementDestination(0:1..1) : BOOLEAN,    IncrementDestination(0:2..2) : BOOLEAN,    IOorMemorySource(0:3..3) : { io, memory },    DecrementSource(0:4..4) : BOOLEAN,    IncrementSource(0:5..5) : BOOLEAN,    StopWhenTransferCountIsZero(0:6..6) : BOOLEAN,    dmaInterruptWhenDone(0:7..7) : BOOLEAN,    Synchronization(0:8..9) : { NoSync, SourceSync, DestSync, NotUsed },    HighChannelPriority(0:10..10) : BOOLEAN,    TransmitDataRequest(0:11..11) : BOOLEAN,    Unused12(0:12..12) : Bit,			-- bit 3 to 80186    ChangeStartChannel(0:13..13) : BOOLEAN,    StartChannel(0:14..14) : BOOLEAN,    ByteOrWordTransfer(0:15..15) : { ByteTransfer, WordTransfer }  ] ;  EncodedDeviceType : TYPE = MACHINE DEPENDENT RECORD   [    Drive0Type(0:0..3) : EncodedDiskDriveType,    Drive1Type(0:4..7) : EncodedDiskDriveType,    Drive2Type(0:8..11) : EncodedDiskDriveType,    Drive3Type(0:12..15) : EncodedDiskDriveType  ] ;  EncodedDiskDriveType : TYPE = MACHINE DEPENDENT { NoDiskDrive(0), sa800DiskDrive(1), anyFloppyDiskDrive(2), sa850DiskDrive(3), sa455DiskDrive(4), sa465DiskDrive(5), sa475DiskDrive(6), fad5000250KBTapeDrive(7), fad5000500KBTapeDrive(8), (15) } ;  EncodedSectorLengthType : TYPE = MACHINE DEPENDENT { x128(0), x256(1), x512(2), x1024(3), x2048(4), x4096(5), xIllegal(6) } ;  ExtendedFDCcommandType : TYPE = MACHINE DEPENDENT  {    NullCommand(00),    FormatTrack(01),    ReadData(02),    ReadDeletedData(03),    ReadID(04),    ReadTrack(05),    Recalibrate(06),    ScanEqual(07),    ScanHighOrEqual(08),    ScanLowOrEqual(09),    Seek(10),    SenseDriveStatus(11),    SenseInterruptStatus(12),    Specify(13),    WriteData(14),    WriteDeletedData(15),    (255)  } ;     fad5000FormatInfoTable: ARRAY EncodedSectorLengthType OF ARRAY FloppyDiskFace.Density OF FormatInfoRecord =    [-- 		single density		  double density	[[ FALSE, 16, 010H, 019H ], [ FALSE,  0,    0,    0 ]],	--  128 bytes/sector	[[ FALSE,  8, 018H, 030H ], [ FALSE, 16, 020H, 032H ]], --  256 bytes/sector	[[  TRUE, 16, 046H, 087H ], [  TRUE, 32, 02AH, 050H ]],	--  512 bytes/sector	[[  TRUE,  8, 0C8H, 0FFH ], [  TRUE, 17, 080H, 0F0H ]],	-- 1024 bytes/sector	[[ FALSE,  1, 0C8H, 0FFH ], [ FALSE,  2, 0C8H, 0FFH ]],	-- 2048 bytes/sector	[[ FALSE,  0,    0,    0 ], [ FALSE,  1, 0C8H, 0FFH ]],	-- 4096 bytes/sector	[[ FALSE,  0,    0,    0 ], [ FALSE,  0,    0,    0 ]]	-- Illegal bytes/sector  ];      fad5000Port80ControlWord: Port80ControlWordRecord = [ --xH    EnableMainMemory : FALSE,    EnableTimerZero : FALSE,    FDDMotorOn : FALSE,    FDDinUse : TRUE,    AllowTimerTC : TRUE,    FDDLowSpeed : TRUE,    SelectChAIntClk : FALSE,    EnableDCEClk : FALSE,    DriveSelect3 : FALSE,    DriveSelect2 : FALSE,    DriveSelect1 : FALSE,    DriveSelect0 : FALSE,    Select250KbDataRate : TRUE,    PreCompensation : 2];      fad5000StepRateTimePlusHeadUnloadTime: Environment.Byte = 0FFH;  fad5000HeadLoadTimePlusNotInDMAmode: Environment.Byte = 02H;  FDCCommandByteOneMask : ARRAY fdcCommandType OF Environment.Byte =  [    000H,	--  NullCommand    05FH,	--  FormatTrack    0FFH,	--  ReadData    0FFH,	--  ReadDeletedData    05FH,	--  ReadID    07FH,	--  ReadTrack    01FH,	--  Recalibrate    0FFH,	--  ScanEqual    0FFH,	--  ScanHighOrEqual    0FFH,	--  ScanLowOrEqual    01FH,	--  Seek    01FH,	--  SenseDriveStatus    01FH,	--  SenseInterruptStatus    01FH,	--  Specify    0DFH,	--  WriteData    0DFH	--  WriteDeletedData  ] ;  FDCCommandByteTwoMask : ARRAY fdcCommandType OF Environment.Byte =  [    000H,	--  NullCommand    007H,	--  FormatTrack    007H,	--  ReadData    007H,	--  ReadDeletedData    007H,	--  ReadID    007H,	--  ReadTrack    003H,	--  Recalibrate    007H,	--  ScanEqual    007H,	--  ScanHighOrEqual    007H,	--  ScanLowOrEqual    007H,	--  Seek    007H,	--  SenseDriveStatus    000H,	--  SenseInterruptStatus    0FFH,	--  Specify    007H,	--  WriteData    007H	--  WriteDeletedData  ] ;  FDCCommandCode : ARRAY fdcCommandType OF Environment.Byte =  [    0,    fdcFormatTrackCommand,    fdcReadDataCommand,    fdcReadDeletedDataCommand,    fdcReadIDCommand,    fdcReadTrackCommand,    fdcRecalibrateCommand,    fdcScanEqualCommand,    fdcScanHighOrEqualCommand,    fdcScanLowOrEqualCommand,    fdcSeekCommand,    fdcSenseDriveStatusCommand,    fdcSenseInterruptStatusCommand,    fdcSpecifyCommand,    fdcWriteDataCommand,    fdcWriteDeletedDataCommand  ] ;  fdcCommandRecord : TYPE = MACHINE DEPENDENT RECORD  [    fdcCode(0:0..7) : ExtendedFDCcommandType,    DataTransferCode(0:8..15) : DataTransferType,    anExtraByte(1:0..7) : Environment.Byte,    MustWaitForInterrupt(1:8..15) : BOOLEAN,    NumberOfCommandBytes(2:0..7) : Environment.Byte,    NumberOfCommandBytesWritten(2:8..15) : Environment.Byte,	-- direct from FDC    CommandBytes(3) : PACKED ARRAY [1..10] OF Environment.Byte,	-- direct to FDC    NumberOfResultBytes(8:0..7) : Environment.Byte,    NumberOfResultBytesRead(8:8..15) : Environment.Byte,	-- direct from FDC    ResultBytes(9) : PACKED ARRAY [1..8] OF Environment.Byte	-- direct from FDC  ] ;  FDCCommandsPerMesaCommand : ARRAY FloppyDiskFace.Function OF CARDINAL =  [    0,		-- nop    3,		-- readSector    3,		-- writeSector    3,		-- writeDeletedSector    3,		-- readID    3		-- formatTrack  ] ;  fdcCommandType : TYPE = ExtendedFDCcommandType[ NullCommand .. WriteDeletedData ] ;  fdcMainStatusRegister : TYPE = MACHINE DEPENDENT RECORD  [    RequestForMaster(0:0..0) : BOOLEAN,    DataInputOutput(0:1..1) : { DataIntoFDC, DataOutOfFDC },    nonDMAmode(0:2..2) : BOOLEAN,    fdcBusy(0:3..3) : BOOLEAN,    DiskDrive3busy(0:4..4) : BOOLEAN,    DiskDrive2busy(0:5..5) : BOOLEAN,    DiskDrive1busy(0:6..6) : BOOLEAN,    DiskDrive0busy(0:7..7) : BOOLEAN  ] ;  fdcStatusRegister0Type : TYPE = MACHINE DEPENDENT RECORD  [    InterruptType(0:0..1) : MACHINE DEPENDENT { NormalTermination(0), AbnormalTermination(1), InvalidCommandIssued(2), ReadyLineChangedDuringCommandExecution(3) },    SeekEnd(0:2..2) : BOOLEAN,    EquipmentCheckError(0:3..3) : BOOLEAN,    NotReadyError(0:4..4) : BOOLEAN,    HeadAddress(0:5..5) : Bit,    DriveNumber(0:6..7) : [0..3]  ] ;  fdcStatusRegister1Type : TYPE = MACHINE DEPENDENT RECORD  [    EndOfTrackError(0:0..0) : BOOLEAN,    NotUsed1(0:1..1) : BOOLEAN,    DataError(0:2..2) : BOOLEAN,    OverRunError(0:3..3) : BOOLEAN,    NotUsed2(0:4..4) : BOOLEAN,    SectorNotFoundError(0:5..5) : BOOLEAN,    WriteProtectError(0:6..6) : BOOLEAN,    MissingAddressMarkError(0:7..7) : BOOLEAN  ] ;  fdcStatusRegister2Type : TYPE = MACHINE DEPENDENT RECORD  [    NotUsed0(0:0..0) : BOOLEAN,    ControlMark(0:1..1) : BOOLEAN,    DataErrorInDataField(0:2..2) : BOOLEAN,    WrongCylinder(0:3..3) : BOOLEAN,    ScanEqualHit(0:4..4) : BOOLEAN,    ScanNotSatisfied(0:5..5) : BOOLEAN,    BadCylinder(0:6..6) : BOOLEAN,    MissingAddressMarkInDataField(0:7..7) : BOOLEAN  ] ;  fdcStatusRegister3Type : TYPE = MACHINE DEPENDENT RECORD  [    Fault(0:0..0) : BOOLEAN,    WriteProtected(0:1..1) : BOOLEAN,    Ready(0:2..2) : BOOLEAN,    Track0(0:3..3) : BOOLEAN,    TwoSided(0:4..4) : BOOLEAN,    theHeadAddress(0:5..5) : Bit,    theDriveNumber(0:6..7) : [0..3]  ] ;  --  FDC Command Five-Bit Constants   fdcFormatTrackCommand		: Environment.Byte = 0DH ;  fdcReadDataCommand		: Environment.Byte = 06H ;  fdcReadDeletedDataCommand	: Environment.Byte = 0CH ;  fdcReadIDCommand		: Environment.Byte = 0AH ;  fdcReadTrackCommand		: Environment.Byte = 02H ;  fdcRecalibrateCommand		: Environment.Byte = 07H ;  fdcScanEqualCommand		: Environment.Byte = 11H ;  fdcScanHighOrEqualCommand	: Environment.Byte = 1DH ;  fdcScanLowOrEqualCommand	: Environment.Byte = 19H ;  fdcSeekCommand		: Environment.Byte = 0FH ;  fdcSenseDriveStatusCommand	: Environment.Byte = 04H ;  fdcSenseInterruptStatusCommand: Environment.Byte = 08H ;  fdcSpecifyCommand		: Environment.Byte = 03H ;  fdcWriteDataCommand		: Environment.Byte = 05H ;  fdcWriteDeletedDataCommand	: Environment.Byte = 09H ;    fillerByteForTapeFormatting: Environment.Byte = 0FFH;  FormatInfoRecord : TYPE = RECORD  [    ValidFormat : BOOLEAN,    SectorsPerTrack : Environment.Byte,    ReadWriteGapLength : Environment.Byte,    FormatGapLength : Environment.Byte  ] ;  FunctionContextBlock : TYPE = MACHINE DEPENDENT RECORD  [    FloppyTask(0) : DoveInputOutput.TaskContextBlock,    FloppyDMAtask(SizeOfTCB) : DoveInputOutput.TaskContextBlock,    FloppyStopHandler(2*SizeOfTCB+0:0..7) : BOOLEAN,			-- must be forced to occupy a BYTE    FloppyResetFDC(2*SizeOfTCB+0:8..15) : BOOLEAN,			-- must be forced to occupy a BYTE    FloppyHandlerIsStopped(2*SizeOfTCB+1:0..7) : BOOLEAN,		-- must be forced to occupy a BYTE    FloppyFDCHung(2*SizeOfTCB+1:8..15) : BOOLEAN,			-- must be forced to occupy a BYTE    FloppyWaitingForDMAInterrupt(2*SizeOfTCB+2:0..7) : BOOLEAN,    FloppyFirstDMAInterrupt(2*SizeOfTCB+2:8..15) : BOOLEAN,		-- must be forced to occupy a BYTE    FloppyDriveMotorControlCount(2*SizeOfTCB+3:0..7) : Environment.Byte,    FloppyTimeoutOccurred(2*SizeOfTCB+3:8..15) : BOOLEAN,    FloppyBadDMAInterruptCount(2*SizeOfTCB+4:0..7) : Environment.Byte,    FloppyBadFDCInterruptCount(2*SizeOfTCB+4:8..15) : Environment.Byte,    FloppyTapeThisIOCB(2*SizeOfTCB+5:0..7) : BOOLEAN,    FloppyExtraByte(2*SizeOfTCB+5:8..15): Environment.Byte,    FloppyFillerByteForFormatting(2*SizeOfTCB+6:0..7) : Environment.Byte,    FloppyDiagnosticsOn(2*SizeOfTCB+6:8..15) : BOOLEAN,    FloppyEncodedDeviceTypes(2*SizeOfTCB+7) : EncodedDeviceType,	-- read from EEPROM by handler    FloppyWorkMask(2*SizeOfTCB+8) : DoveInputOutput.NotifyMask,    FloppyWorkNotify(2*SizeOfTCB+9) : DoveInputOutput.IOPCondition,    FloppyLockMask(2*SizeOfTCB+10) : WORD,    FloppyCurrentIOCB(2*SizeOfTCB+11) : DoveInputOutput.OpieAddress,    FloppyDiagnosticQueue(2*SizeOfTCB+13) : DoveInputOutput.QueueBlock,    FloppyPilotQueue(2*SizeOfTCB+SizeOfQueueBlock+13) : DoveInputOutput.QueueBlock,    Floppy80186Queue(2*SizeOfTCB+2*SizeOfQueueBlock+13) : DoveInputOutput.QueueBlock,    FloppyDCB(2*SizeOfTCB+3*SizeOfQueueBlock+13) : ARRAY [0..MaxNumberOfDiskDrives) OF DeviceContextBlock,    FloppyTotalBytesToTransfer (2*SizeOfTCB+3*SizeOfQueueBlock+13+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): CARDINAL,    FloppyCounterControlRegister (2*SizeOfTCB+3*SizeOfQueueBlock+14+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): CounterControlWord,    FloppyFirstDMAtransferCount (2*SizeOfTCB+3*SizeOfQueueBlock+15+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): CARDINAL,    FloppyFirstDMAcontrolWord  (2*SizeOfTCB+3*SizeOfQueueBlock+16+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): dmaControlWord,    FloppyNumberOfMiddleDMAtransfers (2*SizeOfTCB+3*SizeOfQueueBlock+17+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): CARDINAL,    FloppyMiddleDMAtransferCount (2*SizeOfTCB+3*SizeOfQueueBlock+18+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): CARDINAL,    FloppyMiddleDMAcontrolWord(2*SizeOfTCB+3*SizeOfQueueBlock+19+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): dmaControlWord,    FloppyLastDMAtransferCount (2*SizeOfTCB+3*SizeOfQueueBlock+20+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): CARDINAL,    FloppyLastDMAcontrolWord (2*SizeOfTCB+3*SizeOfQueueBlock+21+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]): dmaControlWord,    FloppyCurrentTrack (2*SizeOfTCB+3*SizeOfQueueBlock+22+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]:0..7): MACHINE DEPENDENT {None(0), MiddleTrack(1), LastTrack(3), (255)},     FloppyExtraByte1 (2*SizeOfTCB+3*SizeOfQueueBlock+22+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]:8..15): Environment.Byte,    FloppyQueueSemaphore (2*SizeOfTCB+3*SizeOfQueueBlock+23+MaxNumberOfDiskDrives*SIZE[DeviceContextBlock]:0..15): CARDINAL      ] ;  ImpliedSeek : ARRAY fdcCommandType OF BOOLEAN =  [    FALSE,	--  NullCommand    TRUE,	--  FormatTrack    TRUE,	--  ReadData    TRUE,	--  ReadDeletedData    TRUE,	--  ReadID		PILOT really does a SeekAndVerify    TRUE,	--  ReadTrack    FALSE,	--  Recalibrate    TRUE,	--  ScanEqual    TRUE,	--  ScanHighOrEqual    TRUE,	--  ScanLowOrEqual    TRUE,	--  Seek    FALSE,	--  SenseDriveStatus    FALSE,	--  SenseInterruptStatus    FALSE,	--  Specify    TRUE,	--  WriteData    TRUE	--  WriteDeletedData  ] ;      InitTrackDMAandCounterControl: TrackDMAandCounterControl = [    TotalBytesToTransfer: 0,    TotalBytesActuallyTransfered: 0,    CounterControlRegister: StopCounter,    FirstDMAtransferCount: 0,    FirstDMAcontrolWord: StopDMA,    NumberOfMiddleDMAtransfers: 0,    MiddleDMAtransferCount: 0,    MiddleDMAcontrolWord: StopDMA,    LastDMAtransferCount: 0,    LastDMAcontrolWord: StopDMA];<<  IOCB General Structure =  [    Driver/Head Shared Memory    PrivateHeadContext    Head/Handler Shared Memory    Head/Handler/Controller Shared Memory    Head/Controller Shared Memory  ] ;>>  IOCB : TYPE = MACHINE DEPENDENT RECORD   [    operation(0) : FloppyDiskFace.Operation,    GeneralizedFDCOperation(8:0..7) : ExtendedFDCcommandType,    savedStatus(8:8..15) : FloppyDiskFace.Status,    theContext(9) : FloppyDiskFace.Context,    AlternateSectors(10:0..0) : BOOLEAN,		-- not really implemented    MultiTrackMode(10:1..1) : BOOLEAN,    SkipDeletedSector(10:2..2) : BOOLEAN,    UnusedForNow(10:3..7) : [0..31],    CurrentTryCount(10:8..15) : FloppyDiskFace.Tries,    OperationIsQueued(11:0..7) : BOOLEAN,    OperationState(11:8..15) : OperationStateType,    NextIOCB(12) : DoveInputOutput.OpieAddress,    DataAddress(14) : DoveInputOutput.OpieAddress,    ActualClientCondition(16) : DoveInputOutput.ClientCondition,    FinalStateOfFDC(19:0..7) : fdcMainStatusRegister,    SpecifyFlag(19:8..15) : BOOLEAN,    PCEResetFDCFlag(20:0..7) : BOOLEAN,    PCEStartMotorFlags(20:8..15) : Environment.Byte,    ResetAndFlushFlag(21:0..7) : BOOLEAN,    RecalFlag(21:8..15) : BOOLEAN,    DaDriveNumber(22:0..7) : Environment.Byte,    FDCHung(22:8..15) : BOOLEAN,    firstTrack(23) : TrackDMAandCounterControl,    FinalDMACount(33) : CARDINAL,    IncrementDataPointer(34:0..7) : BOOLEAN,    TimeoutOccurred(34:8..15) : BOOLEAN,    NumberOfFDCCommands(35) : INTEGER,    CurrentFDCCommand(36) : INTEGER,    fdcCommands(37) : ARRAY [1..MaxfdcCommandsInIOCB] OF fdcCommandRecord,    tapeSelection(76:0..7): {none, tapeOn, tapeOnStreamSelection, formatSelection},    stream(76:8..15):  Environment.Byte, --stream     numberOfMiddleTrackTransfers(77): CARDINAL,    middleTrack(78): TrackDMAandCounterControl,    lastTrack(88): TrackDMAandCounterControl  ] ;  IOCBPtr : TYPE = LONG POINTER TO IOCB ;  IOCBType : TYPE = { NewOp, ContinueOp, RetryOp } ;  LookupFDCOpForMesaOp : ARRAY FloppyDiskFace.Function OF fdcCommandType =  [    NullCommand,	-- nop    ReadData,		-- readSector    WriteData,		-- writeSector    WriteDeletedData,	-- writeDeletedSector    ReadID,		-- readID    FormatTrack		-- formatTrack  ] ;  MaxNumberOfDiskDrives : INTEGER = 4 ;  MaxfdcCommandsInIOCB : INTEGER = 3 ;      maxRetriesForRetention: CARDINAL = 50;      maxStreams: CARDINAL = 12;      maxTracksPerStream: CARDINAL = 245;  MesaClientType : TYPE = { Diagnostics, Pilot } ;  Nibble : TYPE = [0..15] ;  NullAttributes : FloppyDiskFace.Attributes =  [    type : Device.nullType,    numberOfCylinders : 0,    numberOfHeads : 0,    maxSectorsPerTrack : 0,    formatLength : 0,    ready : FALSE,    diskChange : TRUE,    twoSided : FALSE,    busy : TRUE,    unused : 0  ] ;  NullContext : FloppyDiskFace.Context =  [    protect : TRUE,    format : IBM,    density : single,    sectorLength : 0  ] ;  NullfdcCommandRecord : fdcCommandRecord =  [    fdcCode : NullCommand,    DataTransferCode : None,    anExtraByte : 0,    MustWaitForInterrupt : FALSE,    NumberOfCommandBytes : 0,    NumberOfCommandBytesWritten : 0,    CommandBytes : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],    NumberOfResultBytes : 0,    NumberOfResultBytesRead : 0,    ResultBytes : [0, 0, 0, 0, 0, 0, 0, 0]  ] ;  NullFormatInfoRecord : FormatInfoRecord = [ FALSE, 0, 0, 0 ] ;  NumberOfFDCCommandBytes : ARRAY fdcCommandType OF CARDINAL =  [    0,		--  NullCommand    6,		--  FormatTrack    9,		--  ReadData    9,		--  ReadDeletedData    2,		--  ReadID    9,		--  ReadTrack    2,		--  Recalibrate    9,		--  ScanEqual    9,		--  ScanHighOrEqual    9,		--  ScanLowOrEqual    3,		--  Seek    2,		--  SenseDriveStatus    1,		--  SenseInterruptStatus    3,		--  Specify    9,		--  WriteData    9		--  WriteDeletedData  ] ;  NumberOfFDCResultBytes : ARRAY fdcCommandType OF CARDINAL =  [    0,		--  NullCommand    7,		--  FormatTrack    7,		--  ReadData    7,		--  ReadDeletedData    7,		--  ReadID    7,		--  ReadTrack    0,		--  Recalibrate    7,		--  ScanEqual    7,		--  ScanHighOrEqual    7,		--  ScanLowOrEqual    0,		--  Seek    1,		--  SenseDriveStatus    2,		--  SenseInterruptStatus    0,		--  Specify    7,		--  WriteData    7		--  WriteDeletedData  ] ;  OperationStateType : TYPE = MACHINE DEPENDENT { OperationDoesNotExist(0), OperationInvalid(1), OperationBuilt(2), OperationWaiting(3), OperationInProgress(4), OperationAborted(5), OperationCompleted(6), OperationFailed(7), (255) } ;  Port80ControlWordRecord : TYPE = MACHINE DEPENDENT RECORD   [    EnableMainMemory(0:0..0) : BOOLEAN,    EnableTimerZero(0:1..1) : BOOLEAN,    FDDMotorOn(0:2..2) : BOOLEAN,    FDDinUse(0:3..3) : BOOLEAN,    AllowTimerTC(0:4..4) : BOOLEAN,    FDDLowSpeed(0:5..5) : BOOLEAN,			-- this changes the drive motor speed    SelectChAIntClk(0:6..6) : BOOLEAN,    EnableDCEClk(0:7..7) : BOOLEAN,    DriveSelect3(0:8..8) : BOOLEAN,    DriveSelect2(0:9..9) : BOOLEAN,    DriveSelect1(0:10..10) : BOOLEAN,    DriveSelect0(0:11..11) : BOOLEAN,    Select250KbDataRate(0:12..12) : BOOLEAN,		-- this changes the clock frequency for the FDC    PreCompensation(0:13..15) : [0..7]  ] ;  RecordID : TYPE = RECORD  [    address : FloppyDiskFace.DiskAddress,    sectorLength : CARDINAL,    MachineDependentBytes : PACKED ARRAY [1..4] OF Environment.Byte  ] ;  RecordIDPtr : TYPE = LONG POINTER TO RecordID ;  sa455FormatInfoTable : ARRAY EncodedSectorLengthType OF ARRAY FloppyDiskFace.Density OF FormatInfoRecord =  [-- 		single density		  double density	[[  TRUE, 16, 010H, 019H ], [ FALSE,  0,    0,    0 ]],	--  128 bytes/sector	[[  TRUE,  8, 018H, 030H ], [  TRUE, 16, 020H, 032H ]],	--  256 bytes/sector	[[  TRUE,  4, 046H, 087H ], [  TRUE,  9, 02AH, 050H ]],	--  512 bytes/sector	[[ FALSE,  2, 0C8H, 0FFH ], [ FALSE,  4, 080H, 0F0H ]],	-- 1024 bytes/sector	[[ FALSE,  1, 0C8H, 0FFH ], [ FALSE,  2, 0C8H, 0FFH ]],	-- 2048 bytes/sector	[[ FALSE,  0,    0,    0 ], [ FALSE,  1, 0C8H, 0FFH ]],	-- 4096 bytes/sector	[[ FALSE,  0,    0,    0 ], [ FALSE,  0,    0,    0 ]]	-- Illegal bytes/sector  ] ;  sa455HeadLoadTimePlusNotInDMAmode : Environment.Byte = 014H ;  sa455Port80ControlWord : Port80ControlWordRecord =		-- 3C0AH  [    EnableMainMemory : FALSE,    EnableTimerZero : FALSE,    FDDMotorOn : TRUE,    FDDinUse : TRUE,    AllowTimerTC : TRUE,    FDDLowSpeed : TRUE,    SelectChAIntClk : FALSE,    EnableDCEClk : FALSE,    DriveSelect3 : FALSE,    DriveSelect2 : FALSE,    DriveSelect1 : FALSE,    DriveSelect0 : FALSE,    Select250KbDataRate : TRUE,    PreCompensation : 2  ] ;  sa455StepRateTimePlusHeadUnloadTime : Environment.Byte = 0D1H ;  sa475FormatInfoTable : ARRAY EncodedSectorLengthType OF ARRAY FloppyDiskFace.Density OF FormatInfoRecord =  [-- 		single density		  double density	[[  TRUE, 26, 010H, 019H ], [ FALSE,  0,   0H,   0H ]],	--  128 bytes/sector	[[ FALSE,  0, 018H, 030H ], [  TRUE, 26, 020H, 032H ]],	--  256 bytes/sector	[[ FALSE,  0, 046H, 087H ], [  TRUE, 15, 02AH, 050H ]],	--  512 bytes/sector	[[ FALSE,  0, 0C8H, 0FFH ], [  TRUE,  8, 080H, 0F0H ]],	-- 1024 bytes/sector	[[ FALSE,  0, 0C8H, 0FFH ], [ FALSE,  2, 0C8H, 0FFH ]],	-- 2048 bytes/sector	[[ FALSE,  0,   0H,   0H ], [ FALSE,  1, 0C8H, 0FFH ]],	-- 4096 bytes/sector	[[ FALSE,  0,   0H,   0H ], [ FALSE,  0,   0H,   0H ]]	-- Illegal bytes/sector  ] ;  sa475HeadLoadTimePlusNotInDMAmode : Environment.Byte = 014H ;  sa475Port80ControlWord : Port80ControlWordRecord =		-- 3802H  [    EnableMainMemory : FALSE,    EnableTimerZero : FALSE,    FDDMotorOn : TRUE,    FDDinUse : TRUE,    AllowTimerTC : TRUE,    FDDLowSpeed : FALSE,    SelectChAIntClk : FALSE,    EnableDCEClk : FALSE,    DriveSelect3 : FALSE,    DriveSelect2 : FALSE,    DriveSelect1 : FALSE,    DriveSelect0 : FALSE,    Select250KbDataRate : FALSE,    PreCompensation : 2  ] ;  sa475StepRateTimePlusHeadUnloadTime : Environment.Byte = 0C1H ;  SectorHeaderRecord : TYPE = MACHINE DEPENDENT RECORD   [    Cylinder(0:0..7) : Environment.Byte,    Head(0:8..15) : Environment.Byte,    Sector(1:0..7) : Environment.Byte,    EncodedBytesPerSector(1:8..15) : Environment.Byte  ] ;  SizeOfQueueBlock : CARDINAL = SIZE[DoveInputOutput.QueueBlock] ;  SizeOfTCB : CARDINAL = SIZE[DoveInputOutput.TaskContextBlock] ;  StartCounter : CounterControlWord =		<< = C007 = 140007 Octal >>  [    Enable : TRUE,    ChangeEnable : TRUE,    CounterInterruptWhenDone : FALSE,    RegisterInUse : FALSE,    NotUsed11 : FALSE,    NotUsed10 : FALSE,    NotUsed9 : FALSE,    NotUsed8 : FALSE,    NotUsed7 : FALSE,    NotUsed6 : FALSE,    MaximumCount : FALSE,    Retrigger : FALSE,    Prescaler : FALSE,    External : TRUE,    Alternate : TRUE,    Continuous : TRUE  ] ;  StopCounter : CounterControlWord =		<< = 4004H >>  [    Enable : FALSE,    ChangeEnable : TRUE,    CounterInterruptWhenDone : FALSE,    RegisterInUse : FALSE,    NotUsed11 : FALSE,    NotUsed10 : FALSE,    NotUsed9 : FALSE,    NotUsed8 : FALSE,    NotUsed7 : FALSE,    NotUsed6 : FALSE,    MaximumCount : FALSE,    Retrigger : FALSE,    Prescaler : FALSE,    External : TRUE,    Alternate : FALSE,    Continuous : FALSE  ] ;  StartDMARead : dmaControlWord =		<< = A266H = 121146 Octal >>  [    IOorMemoryDestination : memory,    DecrementDestination : FALSE,    IncrementDestination : TRUE,    IOorMemorySource : io,    DecrementSource : FALSE,    IncrementSource : FALSE,    StopWhenTransferCountIsZero : TRUE,    dmaInterruptWhenDone : FALSE,		-- we may diddle this bit at runtime    Synchronization : SourceSync,    HighChannelPriority : TRUE,    TransmitDataRequest : FALSE,    Unused12 : 0,    ChangeStartChannel : TRUE,    StartChannel : TRUE,    ByteOrWordTransfer : ByteTransfer  ] ;  StartDMAWrite : dmaControlWord =		<< = 16A6H = 13246 Octal >>  [    IOorMemoryDestination : io,    DecrementDestination : FALSE,    IncrementDestination : FALSE,    IOorMemorySource : memory,    DecrementSource : FALSE,    IncrementSource : TRUE,    StopWhenTransferCountIsZero : TRUE,    dmaInterruptWhenDone : FALSE,		-- we may diddle this bit at runtime    Synchronization : DestSync,    HighChannelPriority : TRUE,    TransmitDataRequest : FALSE,    Unused12 : 0,    ChangeStartChannel : TRUE,    StartChannel : TRUE,    ByteOrWordTransfer : ByteTransfer  ] ;  StopDMA : dmaControlWord =			<< = 0204H >>  [    IOorMemoryDestination : io,    DecrementDestination : FALSE,    IncrementDestination : FALSE,    IOorMemorySource : io,    DecrementSource : FALSE,    IncrementSource : FALSE,    StopWhenTransferCountIsZero : TRUE,    dmaInterruptWhenDone : FALSE,    Synchronization : NoSync,    HighChannelPriority : FALSE,    TransmitDataRequest : FALSE,    Unused12 : 0,    ChangeStartChannel : TRUE,    StartChannel : FALSE,    ByteOrWordTransfer : ByteTransfer  ] ;      --TotalBytesActuallyTransfered is actually used only once as firstTrack.TotalBytesActuallyTransfered to mean bytes transferred this track.  It was placed into this record so that firstTrack, middleTrack and lastTrack could be the same record type for coding ease in the head (see InitializeIOCB and SetupDMAInfo).  TotalBytesActuallyTransfered could not be moved because of backward compatibility.  It is not used in the middleTrack and lastTrack records.  TrackDMAandCounterControl: TYPE = MACHINE DEPENDENT RECORD [    TotalBytesToTransfer(0): CARDINAL,    TotalBytesActuallyTransfered(1): CARDINAL,      CounterControlRegister(2): CounterControlWord,    FirstDMAtransferCount(3): CARDINAL,    FirstDMAcontrolWord(4): dmaControlWord,    NumberOfMiddleDMAtransfers(5): INTEGER,    MiddleDMAtransferCount(6): CARDINAL,    MiddleDMAcontrolWord(7): dmaControlWord,    LastDMAtransferCount(8): CARDINAL,    LastDMAcontrolWord(9): dmaControlWord];  UnknownSectorLength : CARDINAL = FIRST[CARDINAL] ;  WaitForInterrupt : ARRAY fdcCommandType OF BOOLEAN =  [    FALSE,	--  NullCommand    TRUE,	--  FormatTrack    TRUE,	--  ReadData    TRUE,	--  ReadDeletedData    TRUE,	--  ReadID    TRUE,	--  ReadTrack    TRUE,	--  Recalibrate    TRUE,	--  ScanEqual    TRUE,	--  ScanHighOrEqual    TRUE,	--  ScanLowOrEqual    TRUE,	--  Seek    FALSE,	--  SenseDriveStatus    FALSE,	--  SenseInterruptStatus    FALSE,	--  Specify    TRUE,	--  WriteData    TRUE	--  WriteDeletedData  ] ;END.	-- of FloppyIOFaceDove.mesa