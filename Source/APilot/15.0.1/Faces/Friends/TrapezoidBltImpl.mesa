-- File: TrapezoidBltImpl.mesa - last edit:-- JPM		29-Oct-86 14:42:42-- Copyright (C) 1984, 1985, 1986 by Xerox Corporation. All rights reserved.DIRECTORY  BitBlt,  ESCAlphaExtras,  Frame USING [GetReturnFrame, ReadPC, WritePC],  Inline USING [DIVMOD],  PrincOps USING [ESCTrapTable, LocalFrameHandle],  TrapezoidBlt;TrapezoidBltImpl: PROGRAM  IMPORTS BitBlt, Frame, Inline  EXPORTS TrapezoidBlt =  BEGIN  TRAPEZOIDBLTNotImplementedInMicrocode: PROC[tzbp:TrapezoidBlt.TBptr] =    BEGIN      lf: PrincOps.LocalFrameHandle ¬ Frame.GetReturnFrame[];      Frame.WritePC[pc: [Frame.ReadPC[lf] + 2], lf: lf];      SoftwareTrapezoidBlt[tzbp];    END; -- TRAPEZOIDBLTNotImplementedInMicrocode  SoftwareTrapezoidBlt: PUBLIC PROC[tzbp:TrapezoidBlt.TBptr] =    BEGIN    -- declare SoftwareTrapezoidBlt variables.      gray: LONG DESCRIPTOR FOR ARRAY OF WORD;      yOffset: NAT ¬ tzbp.misc.yOffset;      bbTableSpace: BitBlt.BBTableSpace;      bbp: BitBlt.BBptr ¬ BitBlt.AlignedBBTable[@bbTableSpace];      dstWord, dstBit, dstBitAdjust: CARDINAL;      gray.BASE ¬ tzbp.src.word - tzbp.misc.yOffset;      gray.LENGTH ¬ tzbp.misc.heightMinusOne + 1;      dstBitAdjust ¬ tzbp.src.bit + 16 - tzbp.xMin.val.int MOD 16;      bbp.flags ¬ [disjoint:TRUE, disjointItems:TRUE, gray:TRUE, srcFunc:tzbp.misc.srcFunc, dstFunc:tzbp.misc.dstFunc];      IF NotSteep[tzbp.xMin] OR NotSteep[tzbp.xMax] THEN {        bbp.height ¬ 1;	FOR n:NAT IN [0..tzbp.height) DO	  bbp.srcDesc.gray.yOffset ¬ yOffset MOD gray.LENGTH;	  [dstWord, dstBit] ¬ Inline.DIVMOD[tzbp.xMin.val.int, 16];	  bbp.dst ¬ [word:tzbp.dst.word+dstWord, bit:dstBit];	  bbp.src ¬ [word:gray.BASE+bbp.srcDesc.gray.yOffset, bit:(dstBit+dstBitAdjust) MOD 16];	  bbp.width ¬ tzbp.xMax.val.int - tzbp.xMin.val.int;	  BitBlt.BITBLT[bbp];	  tzbp.dst.word ¬ tzbp.dst.word+( tzbp.dstBpl / 16 );	  tzbp.xMin.val.li ¬ tzbp.xMin.val.li + tzbp.xMin.dVal.li;	  tzbp.xMax.val.li ¬ tzbp.xMax.val.li + tzbp.xMax.dVal.li;	  yOffset ¬ yOffset+1;	  ENDLOOP}       ELSE {          bltL: NAT ¬ tzbp.xMin.val.int;	  bltR: NAT ¬ tzbp.xMax.val.int;	  [dstWord, dstBit] ¬ Inline.DIVMOD[bltL, 16];	  bbp.height ¬ 1;	  bbp.dstBpl ¬ tzbp.dstBpl;	  bbp.srcDesc ¬ [gray[BitBlt.GrayParm[yOffset:0, widthMinusOne:0, heightMinusOne: gray.LENGTH-1]]];	  IF tzbp.height<=0 THEN RETURN;	  DO	     IF (tzbp.height ¬ tzbp.height-1) = 0 THEN EXIT;	     tzbp.xMin.val.li ¬ tzbp.xMin.val.li + tzbp.xMin.dVal.li;	     tzbp.xMax.val.li ¬ tzbp.xMax.val.li + tzbp.xMax.dVal.li;	     IF bltL=tzbp.xMin.val.int AND bltR=tzbp.xMax.val.int THEN {	        bbp.height ¬ bbp.height+1; LOOP};	     bbp.srcDesc.gray.yOffset ¬ yOffset MOD gray.LENGTH;	     bbp.dst ¬ [word:tzbp.dst.word+dstWord, bit:dstBit];	     bbp.src ¬ [word:gray.BASE+bbp.srcDesc.gray.yOffset, bit:(dstBit+dstBitAdjust) MOD 16];	     bbp.width ¬ bltR-bltL;	     BitBlt.BITBLT[bbp];	     IF bltL#tzbp.xMin.val.int THEN	       [dstWord, dstBit] ¬ Inline.DIVMOD[tzbp.xMin.val.int, 16];	     bltL ¬ tzbp.xMin.val.int;	     bltR ¬ tzbp.xMax.val.int;	     tzbp.dst.word ¬ tzbp.dst.word+bbp.height*( tzbp.dstBpl / 16 );	     yOffset ¬ yOffset+bbp.height;	     bbp.height ¬ 1;	     ENDLOOP;	  bbp.srcDesc.gray.yOffset ¬ yOffset MOD gray.LENGTH;	  bbp.dst ¬ [word:tzbp.dst.word+dstWord, bit:dstBit];	  bbp.src ¬ [word:gray.BASE+bbp.srcDesc.gray.yOffset, bit:(dstBit+dstBitAdjust) MOD 16];	  bbp.width ¬ bltR-bltL;	  BitBlt.BITBLT[bbp];	  };        END; -- TRAPEZOIDBLTNotImplementedInMicrocode  NotSteep: PROC[edge: TrapezoidBlt.Interpolator] RETURNS [BOOLEAN] = INLINE {    RETURN[ABS[edge.dVal.li] >= steepSlope]};  steepSlope: LONG CARDINAL ¬ 50000;  -- make compiling rectangles worthwhile  -- to shut off accellerator, set steepSlope ¬ 0  -- Main Line code  PrincOps.ESCTrapTable[ESCAlphaExtras.aTRAPZBLT] ¬ LOOPHOLE[TRAPEZOIDBLTNotImplementedInMicrocode];  END.LOGReinhart 28-Aug-86  placed Mesa BltGrayTrap code into microcode interface compatable procedure called software TrapezoidBlt. Added EscTrap path for single bank systems.Monahan 29-Oct-86  removed BitOps references.