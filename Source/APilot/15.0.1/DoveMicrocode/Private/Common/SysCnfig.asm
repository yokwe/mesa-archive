;-- SysCnfig.asm;-- ReCreated		22-Jun-85 15:59:56	by: AMR;-- Last edited:	12-Aug-85  9:23:51	by: JPM	Change IOPEInRAM alignment to WORD;-- Last edited:	 7-Aug-85  8:07:12	by: JPM	Opie redesign conversion;-- Last edited:	25-Jul-85 13:52:20	by: AMR;Copyright (C) 1985 by Xerox Corporation. All rights reserved.;--;--	NAME		SysCnfig;--------------------------------------------------------------------------------$NOLIST$INCLUDE	(IOPDefs.asm)$INCLUDE	(IOPMacro.asm)$INCLUDE	(HardDefs.asm)$LIST	EXTRN			ConfigurationHandlerID: ABS;	cmdReadAll		EQU	1	cmdWriteAll		EQU	2	cmdReadEntry		EQU	3	cmdWriteEntry		EQU	4		success			EQU	1	eePromError		EQU	2	badCommand		EQU	3		done			EQU	0	notDone			EQU	1	ConfigurationIOR	SEGMENT		COMMON				Assume DS:ConfigurationIOR					EXTRN			SysCnfigTask: TaskContextBlock	EXTRN			SysConfigDownCndt: CONDITION	EXTRN			SysConfigDownMask: WORD	EXTRN			DownCommand: BYTE	EXTRN			DownEntry: BYTE	EXTRN			UpStatus: WORD	EXTRN			SysConfigUpCndt: ClientCondition	EXTRN			SysConfigUpDoneFlag: WORD	EXTRN			SysConfigEEPromImage: WORDConfigurationIOR	ENDSConfigurationSTK	SEGMENT		COMMON					EXTRN			SysCnfigStack: WORDConfigurationSTK	ENDSIOPEInRAM		SEGMENT		WORD PUBLIC				Assume CS:IOPEInRAM		EXTRN		ReadEEProm: NEAR	EXTRN		WriteEEProm: NEAR	EXTRN		EraseEEProm: NEAR	EXTRN		EWEnableEEProm: NEAR	EXTRN		EWDisableEEProm: NEAR	EXTRN		ResetEEProm: NEAR		PUBLIC		ConfigurationInit; Control module	SysCnfigTaskInit:				%GetWorkMaskForCondition (OFFSET SysConfigDownCndt)			MOV	DS: SysConfigDownMask, Ax			JMP	SysConfigEntry					Exit:		MOV	AX, done			MOV	SysConfigUpDoneFlag, AX			%NotifyClientCondition	(SysConfigUpCndt)				SysConfigEntry:	%WaitForCondition (OFFSET SysConfigDownCndt,noTimeout)	;Wakeup with a down Notify			MOV	AX, notDone			MOV	SysConfigUpDoneFlag, AX			MOV	AX, success			MOV	UpStatus, AX			MOV	AX, DS			MOV	ES, AX			MOV	SI, OFFSET SysConfigEEPromImage			XOR	AX, AX			MOV	CX, 64			MOV	AL, DownEntry			MOV	BX, AX			MOV	AL, DownCommand			CMP	AL, cmdReadAll			JE	ReadLoop						CMP	AX, cmdWriteEntry			JE	WriteEntry						MOV	AX, badCommand			MOV	UpStatus, AX						JMP	Exit				ReadLoop:	XOR	BX, BX	LoadLoop:	CALL	ReadEEProm			MOV	ES:[SI], AX			INC	BX			ADD	SI, 2			LOOP	LoadLoop			JMP	Exit		WriteEntry:	MOV	CX, BX			SHL	CX, 1			ADD	SI, CX			MOV	AX, ES:[SI]			CALL	EWEnableEEProm			CALL	EraseEEProm			CALL	WriteEEProm			CALL	ReadEEProm			CMP	AX, ES:[SI]			JE	DisableExit			MOV	AX, eePromError			MOV	UpStatus, AX		DisableExit:	CALL	EWDisableEEProm				JMP	EXIT;--------------------------------------------------------------------------------ConfigurationInit	PROC	FAR			%InitializeTask (ConfigurationHandlerID,OFFSET SysCnfigTask,SysCnfigTaskInit,OFFSET SysCnfigStack)				RETConfigurationInit	ENDPIOPEInRAM		ENDS;********************************************************************************END