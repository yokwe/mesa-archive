-- Copyright (C) 1983  by Xerox Corporation. All rights reserved. -- DiskChannelInternal.mesa      11-Jan-83 15:14:00 by KAM     -- This is a private interface for use ONLY between DiskChannelResident-- and DiskChannelSwappable in the disk driver configuration.DIRECTORY  Device USING [Type],  DiskChannel USING [DiskPageCount, DiskPageNumber, DriveState],  DiskScheduler USING [DriveData, RequestHandle, Scheduler],  PilotDisk USING [Handle],  PilotDiskFace USING [DiskAddress, Operation];DiskChannelInternal: DEFINITIONS =  BEGIN  --~~~~~~~~ Concrete representation of DiskChannel.Handle:  Handle: TYPE = RECORD [drive: Drive, changeCount: CARDINAL];  --~~~~~~~~ Concrete representation of DiskChannel.DriveObject:  Drive: TYPE = LONG POINTER TO DriveObject;  DriveObject: TYPE = MACHINE DEPENDENT RECORD [    type(0): Device.Type,    handle(1): PilotDisk.Handle,    changeCount(2): CARDINAL,    cylinders(3): CARDINAL,    movingHeads(4): CARDINAL,    fixedHeads(5): CARDINAL,    sectorsPerTrack(6): CARDINAL,    driveOrdinal(7): CARDINAL ¬ NULL,    next(8): Drive ¬ NULL,    state(10:0..1): DiskChannel.DriveState,    diskTypeKnown(10:2..15): BOOLEAN,    nPages(11): DiskChannel.DiskPageCount,    tag(13): CARDINAL ¬ NULL,    schedulerWord(14): LONG UNSPECIFIED ¬ 0,    firstFreeOperation(16): OperationPtr];  --~~~~~~~~ Values exported by DiskChannelResident:  firstDrive: READONLY Drive;  countDrives: READONLY CARDINAL;  Operation: TYPE = RECORD [    req: DiskScheduler.RequestHandle,    countSubmitted: DiskChannel.DiskPageCount,  -- pages requested from the Face.    nextFree: OperationPtr,  -- (only meaningful when free)    diskOp: PilotDiskFace.Operation,  -- (must be 16-aligned)    diskOpExtension:      -- actual size is PilotDiskFace.operationSize - SIZE[PilotDiskFace.Operation].      ARRAY [0..0) OF WORD];  OperationPtr: TYPE = LONG POINTER TO Operation;    -- for DiskChannel.DirectOperation... must agree with first part of Operation  DiskChannelPrivate: PUBLIC TYPE = RECORD [    req: DiskScheduler.RequestHandle,    countSubmitted: DiskChannel.DiskPageCount,    nextFree: OperationPtr];  --~~~~~~~~ Procedures to allow DiskChannelSwappable to modify  -- a DriveObject inside DiskChannelResident's monitor.  ChangeDriveChangeCount: PROCEDURE [drive: Drive, changeCount: CARDINAL];  ChangeDriveState: PROCEDURE [drive: Drive, state: DiskChannel.DriveState];  ChangeDriveType: PROCEDURE [    drive: Drive, type: Device.Type,    cylinders, movingHeads, fixedHeads, sectorsPerTrack: CARDINAL];  --~~~~~~~~ The procedures implementing the scheduler:  scheduler: READONLY DiskScheduler.Scheduler;  ChangeScheduler: PROCEDURE [    new: DiskScheduler.Scheduler, driveData: LONG POINTER TO DriveDataArray];  -- Used by DiskChannelSwappable to request DiskChannelResident  -- to change the scheduler.  DriveDataArray: TYPE = ARRAY [0..0) OF DiskScheduler.DriveData;  --~~~~~~~~ Other:  CalculatePageAddress: PROCEDURE [drive: Drive, page: DiskChannel.DiskPageNumber]    RETURNS [PilotDiskFace.DiskAddress];  END.    LOG19-Jun-82 17:33:05   KAM     Created file.19-Nov-82 15:39:28   WDK        Rearranged MyOperation so as to allow it to be actually declared as a record(!). Renamed MyOperation to Operation, file name from DiskChannelOps to DiskChannelInternal. Moved BugType to impls.11-Jan-83 13:34:52   KAM     Moved Scheduler into DiskScheduler; added definition of DiskChannelPrivate.