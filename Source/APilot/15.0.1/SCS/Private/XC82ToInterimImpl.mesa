-- XC82ToInterimImpl.mesa-- Last edited by Alfvin on 17-Apr-84 17:48:03DIRECTORY  Inline,  JapaneseKanji,  NSString,  NSStringConvertInternal,  NSStringConvert,  Runtime;XC82ToInterimImpl: PROGRAM  IMPORTS Inline, NSStringConvert, JapaneseKanji, Runtime  EXPORTS NSStringConvertInternal =  BEGIN OPEN NSStringConvertInternal, JapaneseKanji;  jdsToInterimMap: JDSToInterimObjectHandle _ NIL;  ConvertXC82ToInterim: PUBLIC PROC [c: NSString.Character]    RETURNS [newChar: NSString.Character] =    BEGIN    SELECT c.chset FROM      0 =>        newChar _          SELECT c.code FROM            IN [41B..43B] => c,            44B => [0, 250B],            IN [45B..46B] => c,            47B => [20B, 46B],            IN [50B..54B] => c,            55B => [20B, 45B],            IN [56B..176B] => c,            IN [241B..243B] => c,            244B => [0, 44B],            245B => c,            247B => c,            251B => [0, 140B],            252B => [20B, 50B],            253B => c,            254B => [20B, 55B],            255B => [20B, 54B],            256B => [20B, 57B],            257B => [20B, 56B],            IN [260B..270B] => c,            271B => [0, 47B],            272B => [20B, 51B],            IN [273B..317B] => c,            322B => [20B, 147B],            323B => [20B, 146B],            324B => [20B, 241B],            IN [340B..376B] => c,            ENDCASE => unknownChar;      41B =>        BEGIN        ci: CharIndex _ VAL[c.code];        leftHalfTable: LeftHalfTable = [          c42B: [2, 171B], c43B: [2, 172B], c44B: [4, 376B],	  c53B: [21B, 160B], c54B: [21B, 161B], c63B: [2, 367B], c64B: [2, 370B],          c65B: [2, 167B], c66B: [2, 170B], c67B: [21B, 245B], c70B: [21B, 255B],          c71B: [60B, 0], c72B: [21B, 254B], c73B: [60B, 1], c74B: [2, 371B],          c76B: [0, 55B], c102B: [20B, 110B], c104B: [21B, 244B],          c105B: [21B, 243B], c114B: [21B, 250B], c115B: [21B, 251B],          c126B: [2, 173B], c127B: [2, 174B], c130B: [2, 175B], c131B: [2, 176B],          c132B: [21B, 246B], c133B: [21B, 247B], c142B: [20B, 162B],          c145B: [20B, 100B], c146B: [20B, 101B], c147B: [20B, 161B],          c150B: [20B, 156B], c151B: [20B, 316B], c152B: [20B, 277B],          c154B: [20B, 126B], c155B: [20B, 127B], c156B: [21B, 162B],          c171B: [20B, 343B], c172B: [20B, 363B], c173B: [20B, 344B],          c174B: [20B, 364B], c175B: [20B, 141B], c176B: [20B, 342B],          c177B: unknownChar];        newChar _          SELECT ci FROM	    IN LeftHalf => leftHalfTable[ci],	    ENDCASE => unknownChar;        END;      42B =>        newChar _          SELECT c.code FROM            41B => [20B, 362B],            42B => [20B, 120B],            43B => [20B, 140B],            44B => [20B, 341B],            45B => [20B, 361B],            46B => [20B, 340B],            47B => [20B, 360B],            IN [50B..51B] => [21B, 252B + c.code - 50B],            56B => [21B, 242B],            ENDCASE => unknownChar;      43B => newChar _ SELECT c.code FROM ENDCASE => unknownChar;      44B =>        newChar _          SELECT c.code FROM            IN [41B..176B] => [2, c.code],            IN [241B..376B] => [4, 41B + c.code - 241B],            ENDCASE => unknownChar;      45B =>        newChar _          SELECT c.code FROM            IN [41B..176B] => [2, 241B + c.code - 41B],            IN [241B..376B] => [2, 41B + c.code - 241B],            ENDCASE => unknownChar;      46B =>        newChar _          SELECT c.code FROM            IN [41B..70B] => [1, c.code],            IN [101B..130B] => [1, c.code],            140B => [1, 71B],            141B => [1, 131B],            142B => [1, 111B],            ENDCASE => unknownChar;      47B =>        newChar _          SELECT c.code FROM            IN [41B..176B] => [1, 241B + c.code - 41B],            ENDCASE => unknownChar;      50B =>        newChar _          SELECT c.code FROM            IN [43B..52B] => [22B, c.code],            ENDCASE => unknownChar;      IN [FIRST[StandardJIS1Chset]..LAST[StandardJIS2Chset]] => {        row: CARDINAL _ Inline.BITAND[c.chset, 177B] - 32;        col: CARDINAL _ Inline.BITAND[c.code, 177B] - 32;        jiscode: CARDINAL _ (row - 1) * 94 + col;        SELECT jiscode FROM          IN [1411..4389] =>  -- JIS1 Kanji            {            IF jdsToInterimMap = NIL THEN              jdsToInterimMap _ Runtime.GetTableBase[StandardToInterimKanjiMap];            newChar _ jdsToInterimMap[jiscode - 1411]};          IN [firstJIS2Code..lastJIS2Code] => {  --  JIS2 Kanji             [newChar.chset, newChar.code] _ Inline.DIVMOD[              jiscode - firstJIS2Code, 255];            newChar.chset _ newChar.chset + 74B};          ENDCASE => newChar _ unknownChar};      164B =>        newChar _          SELECT c.code FROM            41B => [21B, 241B],            IN [42B..57B] => [21B, 260B + c.code - 42B],            ENDCASE => unknownChar;      IN ChineseKanjiChset => newChar _ c;      357B =>        BEGIN        ci: CharIndex _ VAL[c.code];        leftHalfTable: LeftHalfTable = [          c41B: [20B, 41B], c42B: [20B, 42B], c43B: [20B, 43B], c44B: [20B, 44B],          c50B: [20B, 47B], c60B: [20B, 130B], c61B: [20B, 131B],          c62B: [20B, 62B], c63B: [20B, 63B], c64B: [20B, 64B], c65B: [20B, 65B],          c66B: [20B, 66B], c67B: [20B, 67B], c70B: [20B, 70B],	  c71B: [20B, 71B], c72B: [20B, 256B], c73B: [20B, 257B],          c74B: [20B, 74B], c75B: [20B, 76B], c76B: [20B, 77B], c77B: [20B, 75B],          c100B: [20B, 60B], c101B: [21B, 174B], c102B: [20B, 102B],          c103B: [20B, 103B], c104B: [20B, 104B], c105B: [20B, 105B],          c106B: [20B, 106B], c107B: [20B, 107B], c110B: [20B, 110B],          c111B: [20B, 111B], c112B: [20B, 112B], c113B: [20B, 113B],          c114B: [20B, 132B], c115B: [20B, 115B], c116B: [20B, 116B],          c117B: [20B, 117B], c120B: [20B, 136B], c121B: [20B, 134B],          c122B: [20B, 114B], c123B: [20B, 135B], c124B: [20B, 252B],          c125B: [20B, 253B], c126B: [20B, 254B], c127B: [20B, 255B],          c130B: [20B, 272B], c131B: [20B, 273B], c132B: [20B, 274B],          c133B: [20B, 275B], c134B: [20B, 312B], c135B: [20B, 313B],          c136B: [20B, 314B], c137B: [20B, 315B], c140B: [20B, 121B],          c141B: [20B, 133B], c142B: [20B, 142B], c143B: [20B, 143B],          c144B: [20B, 144B], c145B: [20B, 145B], c146B: [20B, 150B],          c147B: [20B, 151B], c150B: [20B, 262B], c151B: [20B, 250B],          c152B: [20B, 160B], c153B: [20B, 61B], c154B: [20B, 154B],          c155B: [20B, 155B], c156B: [21B, 143B], c157B: [20B, 157B],          c160B: [20B, 264B], c161B: [20B, 265B], c162B: [20B, 163B],          c163B: [20B, 164B], c164B: [20B, 165B], c165B: [20B, 166B],          c166B: [20B, 167B], c167B: [20B, 170B], c171B: [20B, 171B],          c172B: [21B, 166B], c173B: [21B, 167B], c174B: [20B, 174B],          c175B: [20B, 175B], c176B: [20B, 176B], c177B: unknownChar];        rightHalfTable: RightHalfTable = [          c241B: [20B, 246B], c242B: [20B, 247B], c243B: [20B, 244B],          c244B: [20B, 245B], c247B: [3, 41B], c250B: [20B, 266B],          c251B: [20B, 263B], c252B: [20B, 242B], c253B: [20B, 251B],          c254B: [20B, 267B], c255B: [20B, 270B], c256B: [20B, 271B],          c260B: [20B, 52B], c261B: [20B, 53B], c262B: [20B, 72B],          c263B: [20B, 73B], c264B: [20B, 152B], c265B: [20B, 153B],          c266B: [20B, 172B], c267B: [20B, 173B], c270B: [20B, 137B],          c271B: [20B, 260B], c272B: [20B, 261B], c273B: [21B, 145B],          c276B: [21B, 175B], c277B: [21B, 170B], c301B: [20B, 300B],          c302B: [20B, 301B], c303B: [20B, 302B], c304B: [20B, 303B],          c305B: [20B, 304B], c306B: [20B, 305B], c307B: [20B, 306B],          c310B: [20B, 307B], c311B: [20B, 310B], c312B: [20B, 311B],          c313B: [20B, 351B], c314B: [20B, 370B], c315B: [20B, 371B],          c316B: [20B, 350B], c317B: [20B, 122B], c320B: [20B, 123B],          c321B: [20B, 320B], c322B: [20B, 321B], c323B: [20B, 322B],          c324B: [20B, 323B], c325B: [20B, 324B], c326B: [20B, 325B],          c327B: [20B, 326B], c330B: [20B, 327B], c331B: [20B, 330B],          c332B: [20B, 331B], c336B: [21B, 165B], c337B: [20B, 124B],          c340B: [20B, 125B], c341B: [20B, 345B], c342B: [20B, 346B],          c343B: [20B, 347B], c344B: [20B, 365B], c345B: [20B, 366B],          c346B: [20B, 367B], c347B: [20B, 376B],	  c350B: [20B, 256B], c351B: [20B, 257B], c352B: [20B, 276B],          c353B: [20B, 317B], c354B: [20B, 336B], c355B: [20B, 337B],	  c356B: [20B, 356B], c357B: [20B, 357B],          c360B: [20B, 332B], c361B: [20B, 333B], c362B: [20B, 334B],          c363B: [20B, 335B], c364B: [20B, 352B], c365B: [20B, 353B],          c366B: [20B, 354B], c367B: [20B, 355B], c370B: [20B, 372B],          c371B: [20B, 373B], c372B: [20B, 374B], c373B: [20B, 375B],          c374B: [20B, 243B], c375B: [21B, 163B], c376B: [21B, 164B],          c377B: unknownChar];        newChar _          SELECT ci FROM            IN LeftHalf => leftHalfTable[ci],            IN RightHalf => rightHalfTable[ci],            ENDCASE => unknownChar;        END;      360B =>        newChar _          SELECT c.code FROM            IN [41B..45B] => [40B, 360B + c.code - 41B],            176B => [40B, 376B],            IN [271B..357B] => [40B, c.code],            IN [366B..373B] => [21B, 41B + c.code - 366B],            IN [374B..375B] => [40B, c.code],            ENDCASE => unknownChar;      361B =>        BEGIN        ci: CharIndex _ VAL[c.code];        leftHalfTable: LeftHalfTable = [          c41B: [40B, 121B], c42B: [40B, 161B], c43B: [40B, 101B],          c44B: [40B, 141B], c50B: [40B, 61B], c51B: [40B, 41B],          c61B: [40B, 122B], c62B: [40B, 162B], c63B: [40B, 102B],          c64B: [40B, 142B], c70B: [40B, 62B], c71B: [40B, 42B],          c101B: [40B, 125B], c102B: [40B, 165B], c103B: [40B, 105B],          c110B: [40B, 65B], c121B: [40B, 126B], c122B: [40B, 166B],          c123B: [40B, 106B], c130B: [40B, 66B], c132B: [40B, 244B],          c141B: [40B, 127B], c142B: [40B, 167B], c143B: [40B, 107B],          c150B: [40B, 67B], c161B: [40B, 130B], c162B: [40B, 170B],          c163B: [40B, 110B], c170B: [40B, 70B], c177B: unknownChar];        rightHalfTable: RightHalfTable = [          c241B: [40B, 133B], c242B: [40B, 173B], c243B: [40B, 113B],          c244B: [40B, 153B], c250B: [40B, 73B], c261B: [40B, 134B],          c262B: [40B, 174B], c263B: [40B, 114B], c264B: [40B, 154B],          c270B: [40B, 74B], c301B: [40B, 135B], c302B: [40B, 175B],          c303B: [40B, 115B], c310B: [40B, 75B], c321B: [40B, 136B],          c322B: [40B, 176B], c323B: [40B, 116B], c330B: [40B, 76B],          c377B: unknownChar];        newChar _          SELECT ci FROM            IN LeftHalf => leftHalfTable[ci],            IN RightHalf => rightHalfTable[ci],            ENDCASE => unknownChar;        END;      362B =>        newChar _          SELECT c.code FROM            112B => [40B, 243B],            132B => [40B, 244B],            ENDCASE => unknownChar;      363B =>        newChar _          SELECT c.code FROM            304B => [40B, 151B],            324B => [40B, 152B],            ENDCASE => unknownChar;      364B =>         newChar _ unknownChar;      365B =>         newChar _ unknownChar;      375B =>        newChar _          SELECT c.code FROM	    257B => [21B, 57B],	    IN [260B..271B] => [21B, 60B + c.code - 260B],            IN [320B..323B] => [22B, c.code],            ENDCASE => unknownChar;      ENDCASE => newChar _ unknownChar;    IF newChar = unknownChar THEN newChar _ NSStringConvert.Error[unknownChar, c];    END;  END.16-Dec-83 16:44:11 - Alfvin - Added ChineseKanjiChset processing 27-Feb-84  3:22:09 - Alfvin - Fix bug in Japanese Kanji processing 16-Apr-84 12:02:29 - Alfvin -  1) Was: [357B, 156B] => [20B, 156B], Now: [357B, 156B] => [21B, 143B]  2) Was: [357B, 273B] => [20B, 261B], Now: [357B, 273B] => [21B, 145B]  3) Was: [357B, 276B] => [40B, 376B], Now: [357B, 276B] => [21B, 175B]  4) Was: [357B, 101B] => [20B, 131B], Now: [357B, 101B] => [21B, 174B]  5) Was: [46B, 241B..376B] => [1B, 241B..376B],       Now: [46B, 241B..376B] => unknownChar  6) Was: [0, 136B] => unknownChar, Now: [0, 136B] => [0, 136B]17-Apr-84 17:48:16 - Alfvin -  1) Was: [375B, 57B] => unknownChar, Now: => [21B, 57B]  2) Was: [375B, 260B..271B] => unknownChar, Now: => [375B, 60B..71B]