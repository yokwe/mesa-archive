-- File SysConfigBadMemImpl.mesa-- Last edited:	 5-Jan-87 10:41:20	RDM	Add badMemConfig message.--  9-Dec-86  9:18:40	RDM-- 27-Aug-85 12:02:30	by: MRY-- Created	18-Jun-85 15:03:47	by: AMR<<	Copyright (C) 1985 by Xerox Corporation. All rights reserved.		The following program was created in 1985 but has not been published within the meaning of the	copyright law, is furnished under license, and may not be used, copied and/or disclosed except	in accordance with the terms of said license.	>>DIRECTORY  Inline	        USING [ LowHalf ],  OfflineDiagInterface  USING [ AbortCurrentTest, AnOptionLine, ARow,				DisplayFixedPositionData,   				FixedPositionDisplayRecord,  				GetAnOptionsRecord, GetANumber, 				GetAnOptionLine, GetAnOption,				GetAFixedPositionDisplayRecord, GetARow,				GetYesNo,			        OfflineDiagnosticProc, OptionsRecord, PutMessage],  SysConfigSubDefs,  SysConfigControlDefs  USING [ msgKey, msgKey1, statusPtr],  SysConfigChannelDefs  USING [ eePromPointer];    SysConfigBadMemImpl: PROGRAM	IMPORTS Inline, OfflineDiagInterface, SysConfigControlDefs, SysConfigChannelDefs			EXPORTS SysConfigSubDefs =	BEGIN OPEN Odi: OfflineDiagInterface, SysConfigControlDefs, SysConfigChannelDefs;  -- ODI stands for OfflineDiagInterface.--******************************************************************************-- ConfigureBadMemPages:--******************************************************************************ConfigureBadMemPages: PUBLIC Odi.OfflineDiagnosticProc =  BEGIN  --   --  -- This fixed-position display record holds the screen information as being  -- displayed at the top of the data area. The rest of the data area still can  -- be used to print normal data (PutData still retains its full power)    optionTable: LONG POINTER TO Odi.OptionsRecord _      Odi.GetAnOptionsRecord [1];  -- Just one row of option here  optionRow0: LONG POINTER TO Odi.AnOptionLine _      Odi.GetAnOptionLine [2]; -- Extra option is for EXIT  --     eepromBadPageOffset: CARDINAL = 36;   leftEdge: CARDINAL = 3;   -- For formatting display.  maxNumberWidth: CARDINAL = 5;  -- Biggest number is 10 digits wide.   noNumericData: CARDINAL = 0;  aSpace: CARDINAL = 1;  xPosition: CARDINAL;  -- Number for tracking position on current line  selected: CARDINAL;  -- The option selected by the user  initialEntry: BOOLEAN _ TRUE;  information: LONG POINTER TO Odi.FixedPositionDisplayRecord _      Odi.GetAFixedPositionDisplayRecord [6];  --  2 single-itemed rows of data    infoRow0: LONG POINTER TO Odi.ARow _ Odi.GetARow [5];  -- 1 item on row  infoRow1: LONG POINTER TO Odi.ARow _ Odi.GetARow [5];  -- 1 item  infoRow2: LONG POINTER TO Odi.ARow _ Odi.GetARow [5];  -- 1 item on row  infoRow3: LONG POINTER TO Odi.ARow _ Odi.GetARow [5];  -- 1 item  infoRow4: LONG POINTER TO Odi.ARow _ Odi.GetARow [5];  -- 1 item on row  infoRow5: LONG POINTER TO Odi.ARow _ Odi.GetARow [1];  -- 1 item    -- Option table     optionTable.linesOfOptions[0] _ optionRow0; -- Save pointer to row  optionTable.optionMenuTiTle _ msgKey[configBadMemPages];    optionRow0.optionsOnALine[0].position _ leftEdge;  optionRow0.optionsOnALine[0].selectionNumberForThisItem _ 1;  optionRow0.optionsOnALine[0].option _ msgKey[configBadMemPages];  -- %Change    xPosition _ leftEdge + msgKey[respondToPrompt].length + 8;  -- %Change  optionRow0.optionsOnALine[1].position _ xPosition;  optionRow0.optionsOnALine[1].selectionNumberForThisItem _ 2;  optionRow0.optionsOnALine[1].option _ msgKey[exitSelection];  -- %Change      -- Now fill in the static fields of the display record        -- Fill in the screen Information record fields  information.displayTitle _ msgKey[badPagesData];  information.rows[0] _ infoRow0;  -- First row  information.rows[1] _ infoRow1;  -- Second row  information.rows[2] _ infoRow2;  -- First row  information.rows[3] _ infoRow3;  -- Second row  information.rows[4] _ infoRow4;  -- Second row  information.rows[5] _ infoRow5;  -- First row    -- Now fill in the static fields of the display record  --  -- Fill in first row first item static data  infoRow0.rowItems[0].namePosition _ leftEdge;  -- Name position  infoRow0.rowItems[0].name _ msgKey[word1];  infoRow0.rowItems[0].stringValue _ NIL;  -- No string value  infoRow0.rowItems[0].valuePosition _      leftEdge + msgKey[word1].length + aSpace;    -- Fill in first row second item static data  xPosition _ leftEdge + msgKey[word1].length + 8;  infoRow0.rowItems[1].namePosition _ xPosition;  -- Name position  infoRow0.rowItems[1].name _ msgKey[word2];  infoRow0.rowItems[1].stringValue _ NIL;  -- No string value  infoRow0.rowItems[1].valuePosition _      xPosition + msgKey[word2].length + aSpace;    -- Fill in first row third item static data  xPosition _ xPosition + msgKey[word2].length + 8;  infoRow0.rowItems[2].namePosition _ xPosition;  -- Name position  infoRow0.rowItems[2].name _ msgKey[word3];  infoRow0.rowItems[2].stringValue _ NIL;  -- No string value  infoRow0.rowItems[2].valuePosition _      xPosition + msgKey[word3].length + aSpace;    -- Fill in first row fourth item static data  xPosition _ xPosition + msgKey[word3].length + 8;  infoRow0.rowItems[3].namePosition _ xPosition;  -- Name position  infoRow0.rowItems[3].name _ msgKey[word4];  infoRow0.rowItems[3].stringValue _ NIL;  -- No string value  infoRow0.rowItems[3].valuePosition _      xPosition + msgKey[word4].length + aSpace;    -- Fill in first row fifth item static data  xPosition _ xPosition + msgKey[word4].length + 8;  infoRow0.rowItems[4].namePosition _ xPosition;  -- Name position  infoRow0.rowItems[4].name _ msgKey[word5];  infoRow0.rowItems[4].stringValue _ NIL;  -- No string value  infoRow0.rowItems[4].valuePosition _      xPosition + msgKey[word3].length + aSpace;    -- Fill in second row first item static data  infoRow1.rowItems[0].namePosition _ leftEdge;  -- Name position  infoRow1.rowItems[0].name _ msgKey[word6];  infoRow1.rowItems[0].stringValue _ NIL;  -- No string value  infoRow1.rowItems[0].valuePosition _      leftEdge + msgKey[word6].length + aSpace;    -- Fill in second row second item static data  xPosition _ leftEdge + msgKey[word6].length + 8;  infoRow1.rowItems[1].namePosition _ xPosition;  -- Name position  infoRow1.rowItems[1].name _ msgKey[word7];  infoRow1.rowItems[1].stringValue _ NIL;  -- No string value  infoRow1.rowItems[1].valuePosition _      xPosition + msgKey[word7].length + aSpace;    -- Fill in second row third item static data  xPosition _ xPosition + msgKey[word7].length + 8;  infoRow1.rowItems[2].namePosition _ xPosition;  -- Name position  infoRow1.rowItems[2].name _ msgKey[word8];  infoRow1.rowItems[2].stringValue _ NIL;  -- No string value  infoRow1.rowItems[2].valuePosition _      xPosition + msgKey[word8].length + aSpace;    -- Fill in second row fourth item static data  xPosition _ xPosition + msgKey[word8].length + 8;  infoRow1.rowItems[3].namePosition _ xPosition;  -- Name position  infoRow1.rowItems[3].name _ msgKey[word9];  infoRow1.rowItems[3].stringValue _ NIL;  -- No string value  infoRow1.rowItems[3].valuePosition _      xPosition + msgKey[word9].length + aSpace;    -- Fill in second row fifth item static data  xPosition _ xPosition + msgKey[word9].length + 8;  infoRow1.rowItems[4].namePosition _ xPosition;  -- Name position  infoRow1.rowItems[4].name _ msgKey[word10];  infoRow1.rowItems[4].stringValue _ NIL;  -- No string value  infoRow1.rowItems[4].valuePosition _      xPosition + msgKey[word10].length + aSpace;    -- Fill in third row first item static data  infoRow2.rowItems[0].namePosition _ leftEdge;  -- Name position  infoRow2.rowItems[0].name _ msgKey[word11];  infoRow2.rowItems[0].stringValue _ NIL;  -- No string value  infoRow2.rowItems[0].valuePosition _      leftEdge + msgKey[word11].length + aSpace;    -- Fill in third row second item static data  xPosition _ leftEdge + msgKey[word11].length + 8;  infoRow2.rowItems[1].namePosition _ xPosition;  -- Name position  infoRow2.rowItems[1].name _ msgKey[word12];  infoRow2.rowItems[1].stringValue _ NIL;  -- No string value  infoRow2.rowItems[1].valuePosition _      xPosition + msgKey[word12].length + aSpace;    -- Fill in third row third item static data  xPosition _ xPosition + msgKey[word12].length + 8;  infoRow2.rowItems[2].namePosition _ xPosition;  -- Name position  infoRow2.rowItems[2].name _ msgKey[word13];  infoRow2.rowItems[2].stringValue _ NIL;  -- No string value  infoRow2.rowItems[2].valuePosition _      xPosition + msgKey[word13].length + aSpace;    -- Fill in third row fourth item static data  xPosition _ xPosition + msgKey[word13].length + 8;  infoRow2.rowItems[3].namePosition _ xPosition;  -- Name position  infoRow2.rowItems[3].name _ msgKey[word14];  infoRow2.rowItems[3].stringValue _ NIL;  -- No string value  infoRow2.rowItems[3].valuePosition _      xPosition + msgKey[word14].length + aSpace;    -- Fill in third row fifth item static data  xPosition _ xPosition + msgKey[word14].length + 8;  infoRow2.rowItems[4].namePosition _ xPosition;  -- Name position  infoRow2.rowItems[4].name _ msgKey[word15];  infoRow2.rowItems[4].stringValue _ NIL;  -- No string value  infoRow2.rowItems[4].valuePosition _      xPosition + msgKey[word15].length + aSpace;    -- Fill in fourth row first item static data  infoRow3.rowItems[0].namePosition _ leftEdge;  -- Name position  infoRow3.rowItems[0].name _ msgKey[word16];  infoRow3.rowItems[0].stringValue _ NIL;  -- No string value  infoRow3.rowItems[0].valuePosition _      leftEdge + msgKey[word16].length + aSpace;    -- Fill in fourth row second item static data  xPosition _ leftEdge + msgKey[word16].length + 8;  infoRow3.rowItems[1].namePosition _ xPosition;  -- Name position  infoRow3.rowItems[1].name _ msgKey[word17];  infoRow3.rowItems[1].stringValue _ NIL;  -- No string value  infoRow3.rowItems[1].valuePosition _      xPosition + msgKey[word17].length + aSpace;    -- Fill in fourth row third item static data  xPosition _ xPosition + msgKey[word17].length + 8;  infoRow3.rowItems[2].namePosition _ xPosition;  -- Name position  infoRow3.rowItems[2].name _ msgKey[word18];  infoRow3.rowItems[2].stringValue _ NIL;  -- No string value  infoRow3.rowItems[2].valuePosition _      xPosition + msgKey[word18].length + aSpace;    -- Fill in fourth row fourth item static data  xPosition _ xPosition + msgKey[word18].length + 8;  infoRow3.rowItems[3].namePosition _ xPosition;  -- Name position  infoRow3.rowItems[3].name _ msgKey[word19];  infoRow3.rowItems[3].stringValue _ NIL;  -- No string value  infoRow3.rowItems[3].valuePosition _      xPosition + msgKey[word19].length + aSpace;    -- Fill in fourth row fifth item static data  xPosition _ xPosition + msgKey[word19].length + 8;  infoRow3.rowItems[4].namePosition _ xPosition;  -- Name position  infoRow3.rowItems[4].name _ msgKey[word20];  infoRow3.rowItems[4].stringValue _ NIL;  -- No string value  infoRow3.rowItems[4].valuePosition _      xPosition + msgKey[word20].length + aSpace;    -- Fill in fifth row first item static data  infoRow4.rowItems[0].namePosition _ leftEdge;  -- Name position  infoRow4.rowItems[0].name _ msgKey[word21];  infoRow4.rowItems[0].stringValue _ NIL;  -- No string value  infoRow4.rowItems[0].valuePosition _      leftEdge + msgKey[word21].length + aSpace;    -- Fill in fifth row second item static data  xPosition _ leftEdge + msgKey[word21].length + 8;  infoRow4.rowItems[1].namePosition _ xPosition;  -- Name position  infoRow4.rowItems[1].name _ msgKey[word22];  infoRow4.rowItems[1].stringValue _ NIL;  -- No string value  infoRow4.rowItems[1].valuePosition _      xPosition + msgKey[word22].length + aSpace;    -- Fill in fifth row third item static data  xPosition _ xPosition + msgKey[word22].length + 8;  infoRow4.rowItems[2].namePosition _ xPosition;  -- Name position  infoRow4.rowItems[2].name _ msgKey[word23];  infoRow4.rowItems[2].stringValue _ NIL;  -- No string value  infoRow4.rowItems[2].valuePosition _      xPosition + msgKey[word18].length + aSpace;    -- Fill in fifth row fourth item static data  xPosition _ xPosition + msgKey[word23].length + 8;  infoRow4.rowItems[3].namePosition _ xPosition;  -- Name position  infoRow4.rowItems[3].name _ msgKey[word24];  infoRow4.rowItems[3].stringValue _ NIL;  -- No string value  infoRow4.rowItems[3].valuePosition _      xPosition + msgKey[word24].length + aSpace;    -- Fill in fifth row fifth item static data  xPosition _ xPosition + msgKey[word24].length + 8;  infoRow4.rowItems[4].namePosition _ xPosition;  -- Name position  infoRow4.rowItems[4].name _ msgKey[word25];  infoRow4.rowItems[4].stringValue _ NIL;  -- No string value  infoRow4.rowItems[4].valuePosition _      xPosition + msgKey[word25].length + aSpace;    -- Fill in sixth row first item static data  infoRow5.rowItems[0].namePosition _ leftEdge;  -- Name position  infoRow5.rowItems[0].name _ msgKey[word26];  infoRow5.rowItems[0].stringValue _ NIL;  -- No string value  infoRow5.rowItems[0].valuePosition _      leftEdge + msgKey[word26].length + aSpace;    IF SysConfigControlDefs.statusPtr­ # success THEN {    continue: BOOLEAN _ TRUE;    SELECT SysConfigControlDefs.statusPtr­ FROM      eePromError => Odi.PutMessage [msgKey1[eePromReadFailed], TRUE, TRUE];      badCommand => Odi.PutMessage [msgKey1[eePromBadCommand], TRUE, TRUE];      checkSumError => Odi.PutMessage [msgKey1[eePromCheckSumError], TRUE, TRUE];      badMemConfig => Odi.PutMessage [msgKey1[eePromMemConfigError], TRUE, TRUE];      ENDCASE => Odi.PutMessage [msgKey1[eePromUnknownError], TRUE, TRUE];    continue _ Odi.GetYesNo [prompt: msgKey1[doYouWishToContinue]];    IF ~continue THEN SIGNAL Odi.AbortCurrentTest};  DO  -- Loop until STOP is hit or valid data has been received    FOR i: CARDINAL IN [0..5) DO infoRow0.rowItems[i].value _ eePromPointer[i+eepromBadPageOffset]; ENDLOOP;    FOR i: CARDINAL IN [0..5) DO infoRow1.rowItems[i].value _ eePromPointer[i+eepromBadPageOffset+5]; ENDLOOP;    FOR i: CARDINAL IN [0..5) DO infoRow2.rowItems[i].value _ eePromPointer[i+eepromBadPageOffset+10]; ENDLOOP;    FOR i: CARDINAL IN [0..5) DO infoRow3.rowItems[i].value _ eePromPointer[i+eepromBadPageOffset+15]; ENDLOOP;    FOR i: CARDINAL IN [0..5) DO infoRow4.rowItems[i].value _ eePromPointer[i+eepromBadPageOffset+20]; ENDLOOP;    infoRow5.rowItems[0].value _ eePromPointer[eepromBadPageOffset+25];        IF initialEntry THEN {      [] _ Odi.GetAnOption [  -- Always returns a valid option	      optionTable: optionTable,	      optionPrompt: msgKey[blanks], justDisplayTable:TRUE	      ];-- Change screen or Exit      Odi.DisplayFixedPositionData [  -- Display the drive information	      displayData: information, 	      upDateOnly: FALSE];       }		    ELSE {      Odi.DisplayFixedPositionData [  -- Display the drive information	  displayData: information, 	  upDateOnly: TRUE];      };      selected _ Odi.GetAnOption [  -- Always returns a valid option      optionTable: NIL,      optionPrompt: msgKey[respondToPrompt], defaultOption:0      ];-- Change screen or Exit      IF selected = 2 THEN SIGNAL Odi.AbortCurrentTest;  -- Exit requested          [] _ Odi.GetAnOption [  -- Always returns a valid option			optionTable: NIL,			optionPrompt: msgKey[blanks], justDisplayTable:TRUE			];-- Change screen or Exit 	      infoRow0.rowItems[0].value _ 0;         IF initialEntry THEN Odi.PutMessage [msgKey[generalFixedInfoTitle]];          initialEntry _ FALSE;      -- Get  bad page Index       infoRow0.rowItems[0].value _ Odi.GetANumber [	  prompt: msgKey[badPageIndex],	  lowLimit: 1,		--These are dependent on the EEPromDefs structure	  upperLimit: 26,	--These are dependent on the EEPromDefs structure	  numberIsLong: TRUE,	  defaultNumber: infoRow0.rowItems[0].value].longNumber;              infoRow1.rowItems[0].value _		LONG[eePromPointer[Inline.LowHalf[infoRow0.rowItems[0].value+eepromBadPageOffset-1]]];              -- Get bad page value       infoRow1.rowItems[0].value _ Odi.GetANumber [	  prompt: msgKey[badPageValue],	  lowLimit: 0,	  upperLimit: 0FFFFH,	  numberIsLong: TRUE,	  defaultNumber:infoRow1.rowItems[0].value].longNumber;              eePromPointer[Inline.LowHalf[infoRow0.rowItems[0].value+eepromBadPageOffset-1]] _ --Index			      Inline.LowHalf[infoRow1.rowItems[0].value]; --Bad page information              ENDLOOP; -- inner loop           END;  -- ConfigureBadMemPagesEND.logcreated on 18-Jun-85 15:03:47 by Allen Roberts