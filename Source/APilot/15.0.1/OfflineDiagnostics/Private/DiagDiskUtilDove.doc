-- File: DiagDiskUtilDove.doc-- Created on 2-Aug-85 14:23:43 by DJM-- Last edited on  26 Aug 85 09:47:00 PDT by KL-- Last edited on   1-Oct-85  9:56:27 by KL-- Copyright (C) 1985 Xerox Corporation. All rights reserved.NOTE: appended to this document is a list of changes effective in the 12.0g and subsequent updates.1 IntroductionThis document describes the Dove Rigid Disk Utilities package, DiagDiskUtilDove.boot, version 12.0.  This package is not a diagnostic, and presumes a healthy machine.  The Rigid Disk diagnostic DiagRigidDiskDove.boot should always be run immediately before doing bad page table entries to minimize damage to the disk.  The utilities provide a disk formatter, a physical volume scavenger, facilities to display and add new pages to the disk bad page table, and disk page header repair capability.1.1 Related Documents	1) OFLDiagKernelDove.doc - standard user interface for offline diagnostics	2) Dove Program Diagnostic Strategy2 GeneralThe disk utilities is provided as a boot file.  It can be booted from Ethernet or from floppy disks. 3 User Interface and Command DescriptionsThe initial screen displays the contents of the bootfile as:    Formatter, Scavenger, Bad Page Utilities    For a description of the rest of the initial screen, the login sequence, and for a description of the user interface basics, see document "1" referenced under Related Documents.The utility initially prompts the user:    Is this disk unformatted?    The default for this prompt is NO, and the choices are YES or NO.  The help text for this prompt is:    An unformatted disk is a brand new disk that has never been used    It must be formatted first, or other operations may hangThis prompt should be answered NO unless you are certain that the disk has never been formatted.  If the disk has been formatted before and you answer NO to the prompt, the existing bad page table will be saved if the disk is formatted.  At the end of the format operation, you would then be given the choice to discard or reuse the old bad page table.  Also, if the disk has not been formatted, then certain operations which have meaning only to formatted disks cannot be performed. These operations include any commands in the utility other than formatting or scavenging.The main utility menu appears following the "Unformatted Disk" prompt.  If the user class is "Normal User", the menu selections are as follows:    1. Run Physical Volume Scavenger    2. Bad Page Utilities    For the other user classes, the menu selections are:    1. Run Physical Volume Scavenger    2. Format Rigid Disk    3. Bad Page Utilities3.1 Run Physical Volume ScavengerThe help message associated with this menu selection is:        Checks the integrity of the physical volume. Returns the physical volume to a consistent state.        Should I perform safe repair?	- first prompt when "Scavenge Physical Volume" menu item is selected.	If NO is selected, problems will be reported, but will not be repaired.	If YES is selected, repair of data structures will be done which are	not potentially harmful to user data - that is which is safe repair.	This prompt is displayed before the checking begins, therefore	there may, in fact, be nothing to repair.    Should I perform risky repair?	- second prompt when "Scavenge Physical Volume" menu item is selected.	If NO is selected, serious problems will be reported,	but will not be repaired.	If YES is selected, repair of data structures will be done which IS	potentially harmful if there is a problem with the hardware - 	that is, which is RISKY.	This prompt is displayed before the checking begins, therefore	there may, in fact, be nothing to repair.	Risky repair should not be selected unless the disk subsystem 	has been verified in good health by running the disk diagnostics.	Any user data which can be backed up should be backed up before	risky repair.	The help text for the repair prompts is:	    Physical Volume Scavenging    Is responsible for the integrity of the physical disk only    Attempts to repair damaged physical volume data structures	    Are you sure?    Last warning... Are you still sure?	- confirmations requested after the user has selected this command,	and has selected risky repair, since data may be lost.	If the user selects NO for either prompt, the command is	aborted, and the main menu is presented for selection.    Scavenging ...	- message displayed while scavenging is in progress.    No problem found	- completion message of physical volume scavenge when no repair was        necessary    Damage detected ...    Damage Report    Internal Structures:    	- completion message of physical volume scavenge when problems	have been detected.	The bad page table and other data structures which were damaged	are displayed, which may include the Bootfile, the Germ, Pilot	Microcode or Diagnostic Microcode.	Each of these may be reported as "Lost" or "Damaged".	If risky repair had been selected, then an attempt has been	made to repair the damage, and will be reported.	If risky repair had not been selected, then the report will	indicate what areas still have problems.    Has been repaired	- scavenge completion message when risky repair was selected	and attempted.    Volume and boot file formats are inconsistent. Shall I convert it? [Y/N]:	- prompt for physical volume scavenge while scavenging.	It indicates a problem in compatibility between versions of the	boot files and the physical volume.	Conversion is attempted if YES is selected, and the scavenge	resumes.	If NO is selected, the scavenge is terminated immediately, and	the user is returned to the top level menu.	If this prompt keeps recurring even though you select YES,	terminate the command by selecting NO, and contact a service	representative.    Volume cannot be scavenged	- message displayed when the user selected NO to the conversion	prompt while scavenging.3.2 Format Rigid DiskThe help message associated with this menu selection is:        Formats rigid disk, creates physical volume RD0 and logs bad pages    Formatting irrevocably destroys the disk data. Proceed? [Y/N]:	- Confirmation prompt for "Format Rigid Disk" menu item	    Are you sure?    Last warning... Are you still sure?	- further confirmations requested .	If the user selects NO for either prompt, the command is	aborted, and the previous menu is presented for selection.    Number of passes: 	- prompt for Format disk menu command.	The time required for each pass for formatting a disk may be from	three minutes to fifteen minutes depending on the size of the disk.	More than one pass will help to find more potentially bad	spots on the disk.	Numbers of passes for testing a single page indicates the number	of times the page is tested.    Number of retries per pass: 	- prompt for Format disk menu command.	Retries are the number of times that a page will be checked	before declaring it bad.	This retry count is meaningful only for instances when a page is 	detected bad, thus will not increase the time of a scan or formatting	as much as the pass count.	This number should be kept small, such as "0" during formatting to	get the maximum reliability.    PASSES and RETRY COUNTS   <PASSES> is the number of times to go over the disk for bad pages   <RETRY COUNTS> is the number of times to verify a page before declaring it bad	- Help text for the prompts for Pass count and Retry count for	the Format command.      Formatting ...	- displayed in the message window while formatting the disk    Preformat Bad Page Table:	- heading for display of old bad page table.	When a disk is formatted which is not a unformatted disk, the old bad	page table is saved.  This table is then displayed at the end of the	format, when the user is given the choice of combining it with the	new table or discarding the old.     Formatting Information	- heading for display while formatting.	Display includes number of passes, number of retries, whether	or not the old bad page table was saved, and the number of	new bad pages found.	An indicator shows "Saved" to	indicate that a bad page table has been saved from before formatting	and "Not saved" to indicate otherwise.  If saved, the count 	indicates the number of	entries in the old bad page table.     Should I get comfirmation from you page by page?	- After formatting a previously formatted disk, and the user selects to combine	the old bad page with the new, this prompt gives the choice of	adding all the pages from the old bad page table at once (answer NO),	or of adding page by page with further confirmation (answer YES)    RAM bad page table overflowed. Please re-scan disk to catch the remaining bad pages	- While formatting, the internal bad page table ran out of space.	You must use the "Scan" menu command in the Bad Page Utilities	to check for more bad pages after the format finishes.	This may also indicate a hardware failure, so the Rigid Disk	Diagnostics should be run before adding more pages to the bad page	table.	    Preformat bad page table disposistion[ 1-Combine  2-Discard  3-Test ]	- prompt at end of format of previously formatted disk which permits the	user to select to combine the old bad page table with the new,	to discard the old (saved) bad page table, and use only those	pages found while formatting, or to test pages individually.	The pages which are tested are those in the old bad page table.	    Bad Page Disposition    Combine - Adds the preformat bad pages to the current bad page table    Discard - Throws away the preformat bad pages    Test - Users can test, add, repair or discard each page individually	- help text for the prompt after formatting a previously formatted disk.  	    Add this page?	- confirmation requested when adding bad pages from old bad page	table after formatting a previously formatted disk and combining old with new.     Quitting will destroy RAM table. Ready to quit?	- after formatting a previously formatted disk, and combining old bad page table	with new on a page-by-page basis, the user has selected QUIT.	This prompt reminds the user that the old bad page table will	be lost.  YES will return to the page-by-page selection  choice,	and NO will discard the old bad page table, and return to the	top level menu. 3.3 Bad Page UtilitiesThe help message associated with this menu selection is:        Provides various utilities to handle bad pages3.3.1 Display Bad Page Table    Display Bad Page Table    Displays the contents of the existing Bad Page Table	- menu item and help text from Bad Page Utilities menu.	This command displays the bad page table in the bottom section	of the screen.	The entries are sorted by page number.	The display shows the page numbers only.3.3.2 Scan Disk For New Bad Pages    Scan Disk For New Bad Pages	- menu item in the Bad Page Utilities menu    Scans the entire disk surface for bad pages	- help message for "Scan Disk For New Bad Pages" menu item    Please enter the number of times to scan the disk:	- first prompt for Scan disk menu item	indicates the number of passes over the entire disk surface.	The default is 1.  The larger the number of passes, the more	thorough will be the examination of the disk.	Each scan pass will take from three to fifteen minutes, depending	on the size of the disk and the number of retries.	    Scanning disk for new bad pages ...	- progress message while scanning for new bad pages.    Scan Count Information    Desired Scan Count:    Scans Completed:    New Bad Page Count:	- Data displayed while scanning the disk.    Scanning stopped because of RAM bad page table overflow	- termination message for Scan command when more pages are found	than can be saved.	This usually indicates a hardware problem, so the rigid disk diagnostic	should be run to determine if something other than the disk surface	is damaged.  Scanning should be resumed if units other than the disk	drive are replaced.***CONFIRM***    Please Select Option[ 1-Test,  2-Repair,  3-Mark Bad,  4-Next ]	- After scanning the disk for bad pages, this prompt gives the	user the choices indicated for each page which was suspected bad.	Test - rescans the given page, like the Test Page menu command	Repair - attempts to repair the page.	  The user is given an indication of the action required,	  which may include rebooting the volume affected.	Mark Bad - enters the page into the bad page table	Next - goes to the next page in the list.	    Would you like to repeat the operation?    Overflow encountered. Rescan disk to find remainder of bad pages?	- comfirmation prompts at the end of a Scan command which allows	the user to repeat the command without entering the pass count	and retry count again.  The first prompt is the normal completion	prompt and the second prompt is the case where the internal	bad page table overflowed.  3.3.3 Manual Entry of Bad Pages    Manual Entry of Bad Pages    Adds entries to the bad page table by page number or manufacturer's error map	- menu item and help text from Bad Page Utility menu.	This command presents another menu which allows the user to	select to enter by the page number, or via manufacturer's error map	(ie, cylinder, head, sector and offset) 3.3.3.1 Enter by Page Number    Enter by Page Number    Adds a specified bad page to the BAD PAGE TABLE	- menu item and help text from Manual Entry of Bad Pages menu.	When selected, prompts for page number, and adds it to the	Bad Page table,    Please enter bad page number to be marked bad:	- prompt for menu selection to enter bad pages by page number.	The page number must be in the range which is valid for the	disk installed, and cannot be in cylinder 0.    Adding bad pages to the Bad Page Table    Once marked bad, the page can not be re-used    Enter the page number to be added, or STOP to quit	- Help text for the menu item "Add Bad Page to Bad Page Table" 3.3.3.2 Enter by Manufacturer's Error Map    Enter by Manufacturer's Error Map    Converts manufacturers' error map entries into page numbers and adds them to the BAD PAGE TABLE	- menu item and help text from Manual Entry of Bad Pages menu.	When selected, prompts for cylinder, head, sector, offset and	number of bits or bytes in the bad spot.	This series of prompts continues until the user presses "STOP"	to exit back to the  Manual Entry of Bad Pages menu.    Is the bad spot length in bits?    Bad spot length can be given in two formats:    In bits - Bad spot length entered is in bits    In bytes - Bad spot length entered is in bytes	- prompt and help text when the menu item:	  "Enter by Manufacturer's Error Map" is selected.	  YES selects "bits", and NO selects "bytes".	  There are 8 bits in one byte.  The manufacturer's specification	  for the disk will indicate which to select.    Bad page to be added:	- message indicating what page number(s) is affected when adding	bad pages from the manufacturer's bad spot list.	Depending where the spot is on a track, more than one page may	be affected.     Shall I mark the pages bad?	- when entering pages from the manufacturer's bad spot list,	the page number(s) which are affected are displayed, and a confirmation	is requested.  If YES, the page(s) indicated will be added to	the bad page table.  In either case, the user is then	prompted to enter another page.  "STOP" will exit this loop.    Pages marked bad	- when entering bad pages from the manufacturer's bad spot list,	after the page number(s) which are affected are displayed,	and the user confirmed to enter it into the table, this message	is displayed along with the page number(s).    No bad pages written to disk	- while entering bad pages from the manufacturer's list, the	user did not confirm via the prompt to add the page to the bad page	table.	This message indicates that the page(s) indicated were not added.    More to go?	- Final prompt when adding pages to the bad page table.	YES prompts for a new page number, and NO returns to the	menu for entering bad pages.3.3.4 Page Scavenger    Page Scavenger    Attempts to make an unreadable page readable	- menu item and help text  from Bad Page Utilities menu.	Given a page number, this command will attempt to restore the	page if it is damaged. 	The following error messages indicate a hardware problem	other than a media error: 	    Drive not available            Drive not ready	    Invalid page number  	    Unknown drive	The rigid disk diagnostic should be run if any of these errors	occur.		The "User action:" message indicates what the user should do after	the page scavenge is complete:		    Fix page header, mark page bad or call Technical Support	    Reboot volume with the offending page	    Scavenge logical volume containing the specified page	    Scavenge physical volume...	      If no problem found, scavenge the logical volume containing the page  	The following completion messages indicate the status of the operation:    	    Good completion	    Page not found	    Can not verify label	    Failed to seek to cylinder containing page	    Check error. Contents of data can not be verified	    Page has a data CRC error	    Hardware error encountered	    Drive is not ready	    Label CRC error	    Header CRC error	    Header not found	    	The following messages indicate the repair status of the page:	    Page contents Reliable	    Page contents Unreliable	    Page contents Unknown	The final message for this command indicates "Page repaired" or	"Page not repaired"3.3.5 Fix Bad Page Headers    Fix Bad Page Headers    Saves the data on the track with the bad page header, reformats the track and restores the good pages	- menu item and help text from Bad Page Utility menu.	Fixes damaged headers for sectors on the rigid disk.	The data in the bad page, if also damaged, cannot be restored.	The user action required, if any, is displayed when the	header has been repaired.    Broken Page Information    Saving data on track ...    Track data saved    Track will be formatted next... Do you want to continue?    Formatting track ...    Restoring track data...	- data displayes while executing the Fix Bad Page Headers command.	For each page on the track, an indication is displayed of whether or not	the data could be saved.	The table contains the headings:		Page-Number  Cylinder  Head  Sector  Save-Status   Restore-Status		The Save-Status is the status of the read operation before formatting	the track.	The Restore-Status is the status of the write operation after	formatting the track.	If NO is selected in response to the prompt, the repair command	is aborted, and the user is returned to the menu.	If data is lost, the user should scavenge the disk.3.3.6 Reset Bad Page Table    Reset Bad Page Table    Destroys contents of disk and creates a new physical volume	- menu command and help text in the Bad Page Utilities menu	This command should only be used if many entries have been 	entered which are incorrect, and the user wishes to start	the bad page table again.  All entries which had been valid	before resetting should be re-entered to avoid disk problems.     Do you wish to destroy the contents of this disk?	- prompt to confirm the "Reset Bad Page Table" command.	Note that resetting the bad page table will not immediately	destroy the contents of the disk, but the contents can be	damaged subsequently if the disk is used with the bad pages	now made available.		Once the table has been cleared, the user is given the	option to re-enter each of the entries in the old bad page	table, to test each of the pages in the old bad page table,	or to discard the old bad page table.  4 Error Messages    A unformatted disk is a brand new disk that has never been formatted    It must be formatted first, else other operations may hang	- help text for "Is this disk unformatted?" prompt.    Are you sure?    Last warning... Are you still sure?	- confirmations requested after the user has selected a command	which has potential to destroy data.	Such commands include formatting or scavenging with risky repair.	If the user selects NO for either prompt, the command is	aborted, and the previous menu is presented for selection.	    Bad page table on disk is full. Operation aborted.	- termination message when trying to enter bad pages into	the bad page table.	It indicates that no more room exists in the bad page table	on the disk.	When this occurs, the disk can no longer handle bad spots.	If rigid disk diagnostics indicate that the drive is the problem,	it should be replaced.	    Bad pages detected on Cylinder 0! Please contact Technial Support.	- reported whenever bad pages are found (via formatting or scavenging)	on cylinder 0.  This is an unrecoverable error.  The disk cannot be	salvaged.    Bad spot falls in an unused gap. Ignore it	- when entering pages from the manufacturer's bad spot list,	this message indicates that the spot falls into one of the gaps	which are not used on the disk.  It cannot be entered into	the bad page table because it is not in any page.	    Completed	- message displayed when lengthy commands have completed, such	as formatting, scavenging or scanning	    Creating Pilot volume named RD0 to hold Bad Page Table ...	- message displayed at end of format indicating that a physical	volume is created as named    Drive not found. Enter any key to continue:	- Hardware error message which would be displayed before the main menu	Indicates Rigid Disk diagnostics should be run before continuing.	After pressing a key, you will be back at the login menu.    End of bad page table	- message displayed at end of combining old and new bad pages	after formatting a previously formatted disk.    If system hangs, then the disk is either a unformatted disk or the hardware is bad	- warning message put up whenever the physical volume id is being	checked.  If the system pauses or stops at this point, it indicates	a hardware problem.  The Rigid Disk diagnostics should be run before	proceeding.    No bad pages found	- message displayed when the bad page table is selected to be	displayed and the table exists but is empty.    Should I overwrite data if required?	- prompt which occurs whenever a page is selected to be repaired.	This occurs in "Scavenge a page", "Format Rigid Disk", "Scavenge	Physical Volume"	If data is overwritten, it will be lost.	    Soft errors:     Hard errors: 	- data reported when testing a page via the format or scavenge page	commands.	Soft errors indicate that an error occurred but that the operation	succeeded when re-tried, ie not all test passes failed but at least	one did.	Hard errors indicate that the error occurred on every attempt.	If ten retries are selected, and all ten attempts failed, the	error is deemed "Hard".  If the first attempt failed, but at least	one retry succeeded, the error is counted as "soft".	    This operation can not be performed on a unformatted disk!        - warning message which is displayed whenever a command is selected	which is not valid for an unformatted disk and the disk is unformatted.	The disk is unformatted if the user says so via the "unformatted disk"	prompt, or if disk errors occur when trying to read the physical	volume id or the bad page table.  The commands which are disabled	for non-formatted disks include scavenging, displaying or entering	bad pages.  After displaying this message, the current menu	is re-activated for selection.    Unable to access bad page table	- indicates that the physical volume needs scavenging.	This message is displayed (a) when formatting a previously formatted disk,	in which case it is simply assumed to be unformatted and no bad page table	is saved, (b) when displaying the bad page table or entering	new bad pages or resetting the bad page table in which cases	it returns to the bad page menu    5. CHANGES TO THE USER INTERFACE (the following will be merged into the above document at some future time)1) In "Format Rigid Disk", whenever the preformat bad page table is saved and is   not empty, the user can select one of: "Preformat bad page table disposistion[   1-Combine  2-Discard  3-Test ]". If the selection is 3, Test, then old prompt   of   "Please Select Option[ 1-Test,  2-Repair,  3-Mark Bad,  4-Next ]:" has been   changed to:   "Please Select Option[ 1-Test,  2-Repair,  3-Mark Bad,  4-Next,  5-Exit ]:"      This change affects all occurrences of the old prompt, which appears in    "Scan Disk For New Bad Pages",  "Fix Bad Page Headers", "Reset Bad Page Table",   2) In "Scan Disk For New Bad Pages", in order to handle the case where the bad   page list is so long that it is scrolled off the screen, the following new   prompt is given at the end of scanning process IF AND ONLY IF there are bad   pages found:      Bad Page Options[ 1-Redisplay,  2-Test,  3-Exit ]"      1-Redisplay => Redisplays the bad page table, pausing at the bottom of the     screen with the following new prompt:          "More data... Any key will clear current data and continue"          The next screen of data will be displayed after an input. The user can      reselect this option as many consecutive times as he/she desires.      2-Test => Selects the following option list        "Please Select Option[ 1-Test,  2-Repair,  3-Mark Bad,  4-Next,  5-Exit ]:"        3-Exit => Causes "Are you sure?" to be displayed. Loops if no; quits if yes.   3) In "Fix Bad Page Headers", when bad pages are found by the formatter in the   track containing the page with the broken header, the old prompt of:      "Please Select Option[ 1-Mark all pages bad,   2-Examine each page ]:" has been   replaced by    "Options for bad pages found on track[ 1-Mark bad,  2-Test ]"      1-Mark bad => Goes through all the bad pages found on the track. For each page,      		 the user is asked for confirmation by:		 		 "Add this page?"		 		 If yes, the page is marked bad; if no, the page is skipped.		    2-Test => Causes the following prompt to be displayed for each page:          "Please Select Option[ 1-Test,  2-Repair,  3-Mark Bad,  4-Next,  5-Exit ]:"       4) For "Enter By Manufacturer's Error Map", the display has been changed as   follows:      ======== Data Area ===================   Resultant Bad Pages:      <The Pilot page/pages that correspond(s) to the bad spot.      Pages marked bad: <The pages that actually entered into the bad page table>         =======================================      For each new bad spot, the Data Area is cleared so that only the information   that relates to the current bad spot is displayed.      For this selection, users are no longer permitted to respond with cylinder 0   when entering bad spots. The error prompt of "0 is out of range." will be   displayed at the input stage.5) For "Enter By Page Number", users are no longer allowed to enter bad pages    that are in cylinder 0. If a bad page the user enters falls in cylinder 0,   the user will be gven the following prompt at the input stage:      "<Page entered> is out of range." 6) Whenever a page is being added into the bad page table, the following messages   used to be displayed in the Message Area:      ======== Message Area ========   <Page Number>   <"Marked bad" or "Not marked bad"      The new format is now as follows:      ======== Message Area ========   <Page Number><Space><"Marked bad", "Not marked bad" or   		        "Not added because page is in Cylinder 0">   "Not added because page is in Cylinder 0" is displayed whenever an operation   that deals with adding bad pages runs into a page that falls in cylinder 0. 7) For "Format Rigid Disk", the default pass count is now 1, instead of 20. This   is as requested by Ron because  a default of 20 passes simply takes too   long if an a user has entered a <CR> too soon.8) New menu item "Test Bad Pages"   The data area is cleared and a heading is printed as follows:      ======== Data Area ========   Page-Number:	    Cylinder    Head    Sector    Volume         The user is then prompted to enter a page number as follows:      "Please enter a page number:"      The page number is then printed in expanded format below the heading.   The user is then prompted to enter the pass count and retry count as follows:      "Number of passes: " -- This is the number of times to test the page    "Number of retries per pass: "  -- This is the number of retries per test      At the end of the test, the test results are printed below the expanded page   number as follows:       ======== Data Area ========   Page-Number:	    Cylinder     Head    Sector    Volume       <Page>	    <Cylinder>  <head>   <Sector   <Volume name>       Number of passes: <passCount>  Number of retries per pass: <retryCount> Soft errors: <softErrorCount>  Hard errors: <hardErrorCount>          A hard error is defined as a test run in which all retries failed.   A soft error is defined as a test run in which at lease one retry was good.      At the end of the test, the user is asked if there are more tests to run by:      "More to go?"      If yes, the user is prompted to enter another page; if no, the test is exited.   ----- End of change doc ------Dave, does this look ok?/Ken