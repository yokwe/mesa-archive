-- Copyright (C) 1984, 1986, 1988  by Xerox Corporation. All rights reserved. -- DiskEditDriver.mesa   3-Mar-88  8:33:13 by CAJ DIRECTORY  CompatibilityDiskFace USING [Label, OldInitiate],  DiskEditInternal USING [dataPageCount, InitializeViewSwappingWindow,    labelPageCount, MakeDataSW, MakeLabelSW, MakeParamSW],  Environment USING [wordsPerPage],  File USING [ID, nullFile, nullID],  Heap USING [systemZone],  Runtime USING [GetBcdTime, IsBound],  Space USING [Map],  String USING [    AppendChar, AppendOctal, AppendString, AppendSubString, InvalidNumber,    Replace, StringToOctal, SubString, SubStringDescriptor],  System USING [nullID, UniversalID],  Time USING [Append, Packed, Unpack],  Tool USING [Create, MakeFormSW, MakeMsgSW, MakeSWsProc],  ToolWindow USING [State, TransitionProcType],  Version USING [Append],  Window USING [Handle],  WindowSwap USING [DeactivateViewsWindow, Key, nullKey, ReactivateViewsWindow];DiskEditDriver: PROGRAM  IMPORTS CompatibilityDiskFace, DiskEditInternal, Heap, Runtime, Space, String, Time, Tool, Version, WindowSwap  EXPORTS DiskEditInternal =  BEGIN  -- global data  toolWindow: PUBLIC Window.Handle ¬ NIL;  dataSW: PUBLIC Window.Handle;  labelSW: PUBLIC Window.Handle;  msgSW: PUBLIC Window.Handle;  paramSW: PUBLIC Window.Handle;  labels: PUBLIC BOOLEAN ¬ FALSE;  dataPtr: PUBLIC LONG POINTER TO ARRAY [0..Environment.wordsPerPage) OF WORD    ¬ NIL;  diskLabel: PUBLIC LONG POINTER TO CompatibilityDiskFace.Label ¬ NIL;  dataWindowKey: PUBLIC WindowSwap.Key ¬ WindowSwap.nullKey;  ActivateTool: PROCEDURE =    BEGIN    menuWindows: ARRAY [0..2) OF Window.Handle;    menuWindows[0] ¬ paramSW;    menuWindows[1] ¬ labelSW;    WindowSwap.ReactivateViewsWindow[key: dataWindowKey, defaultSW: dataSW,      otherWindows: DESCRIPTOR[BASE[menuWindows], IF labels THEN 2 ELSE 1]];    END;  DeactivateTool: PROCEDURE =    {WindowSwap.DeactivateViewsWindow[key: dataWindowKey]};  MakeSWs: Tool.MakeSWsProc =    BEGIN    -- Make the initial tool subwindows    msgSW ¬ Tool.MakeMsgSW[window: window, lines: 1];    paramSW ¬ Tool.MakeFormSW[      window: window, formProc: DiskEditInternal.MakeParamSW];    labelSW ¬ IF ~labels THEN NIL ELSE Tool.MakeFormSW[      window: window, formProc: DiskEditInternal.MakeLabelSW];    dataSW ¬ Tool.MakeFormSW[      window: window, formProc: DiskEditInternal.MakeDataSW];    -- At initial Create time, the WindowSwap stuff is not yet active.  For    -- activate tool, the alternate view windows, if any, must be recreated.    IF dataWindowKey ~= WindowSwap.nullKey THEN ActivateTool[];    END;  ReplaceFIDString: PUBLIC PROCEDURE [    heapString: LONG POINTER TO LONG STRING, id: File.ID] =    BEGIN    s: STRING ¬ [64];    p1: LONG POINTER = @id;  -- workaround compiler delicacy    p: LONG POINTER TO ARRAY [0..SIZE[File.ID]) OF UNSPECIFIED = p1;    String.AppendChar[s, '[];    FOR i: [0..SIZE[File.ID]) IN [0..SIZE[File.ID] - 1) DO      String.AppendOctal[s, p[i]];      String.AppendString[to: s, from: ", "L];      ENDLOOP;    String.AppendOctal[s, p[SIZE[File.ID] - 1]];    String.AppendChar[s, ']];    --assumed strings taken from system heap    String.Replace[heapString, s, Heap.systemZone];    END;  ReplaceUIDString: PUBLIC PROCEDURE [    heapString: LONG POINTER TO LONG STRING, id: System.UniversalID] =    BEGIN    s: STRING ¬ [64];    p1: LONG POINTER = @id;  -- workaround compiler delicacy    p: LONG POINTER TO ARRAY [0..SIZE[System.UniversalID]) OF UNSPECIFIED = p1;    String.AppendChar[s, '[];    FOR i: [0..SIZE[System.UniversalID]) IN [0..SIZE[System.UniversalID] - 1) DO      String.AppendOctal[s, p[i]];      String.AppendString[to: s, from: ", "L];      ENDLOOP;    String.AppendOctal[s, p[SIZE[System.UniversalID] - 1]];    String.AppendChar[s, ']];    --assumed strings taken from system heap    String.Replace[heapString, s, Heap.systemZone];    END;  Transition: ToolWindow.TransitionProcType =    BEGIN    SELECT TRUE FROM      old = new => RETURN;      new = active =>        BEGIN	IF old = tiny THEN ActivateTool[];	-- IF old = inactive, MakeSWs does it all.	END;      new = tiny => IF old = active THEN DeactivateTool[];      new = inactive => DeactivateTool[];      ENDCASE => ERROR;    END;  ValidateFID: PUBLIC PROCEDURE [s: LONG STRING]    RETURNS [valid: BOOLEAN, id: File.ID] =    BEGIN    p: LONG POINTER = @id;    IF ~(valid ¬ ValidateID[s, p, SIZE[File.ID]])      THEN id ¬ File.nullID;    END;  ValidateID: PROCEDURE [s: LONG STRING,    id: LONG POINTER TO ARRAY [0..0) OF UNSPECIFIED, elements: CARDINAL]    RETURNS [valid: BOOLEAN] =    BEGIN    currentNumber: STRING ¬ [20];    startPos: CARDINAL;    curPos: CARDINAL;    len: CARDINAL;    subStringDesc: String.SubStringDescriptor;    subString: String.SubString ¬ @subStringDesc;    valid ¬ TRUE;    -- Skip over any leading characters that are not octal digits    FOR startPos IN [0..s.length) DO      IF s[startPos] IN ['0..'7] THEN EXIT;      REPEAT FINISHED => GO TO nullReturn;  -- a bogus ID was given      ENDLOOP;    -- Now process each word of the ID    FOR word: CARDINAL IN [0..elements) DO      -- parse each word      curPos ¬ startPos;      WHILE s[curPos] IN ['0..'7] DO        curPos ¬ curPos + 1;        IF curPos >= s.length THEN RETURN;  -- Truncate the ID        ENDLOOP;      IF s[curPos] = 'B OR s[curPos] = 'b THEN len ¬ curPos - startPos + 1      ELSE len ¬ curPos - startPos;      currentNumber.length ¬ 0;      subString­ ¬ [s, startPos, len];      String.AppendSubString[to: currentNumber, from: subString];      id[word] ¬ String.StringToOctal[        currentNumber ! String.InvalidNumber => GO TO nullReturn];      startPos ¬ startPos + len;      UNTIL s[startPos] IN ['0..'7] DO        startPos ¬ startPos + 1;        IF startPos >= s.length THEN RETURN;  -- Truncate the ID        ENDLOOP;      ENDLOOP;    EXITS nullReturn => RETURN[FALSE];    END;  ValidateUID: PUBLIC PROCEDURE [s: LONG STRING]    RETURNS [valid: BOOLEAN, id: System.UniversalID] =    BEGIN    p: LONG POINTER = @id;    IF ~(valid ¬ ValidateID[s, p, SIZE[System.UniversalID]])      THEN id ¬ System.nullID;    END;  Init: PROCEDURE =    BEGIN    name: STRING = [50];    bcdTime: Time.Packed = Runtime.GetBcdTime[];    labels ¬ Runtime.IsBound[LOOPHOLE[CompatibilityDiskFace.OldInitiate]];    -- First create spaces needed to run correctly    dataPtr ¬ Space.Map[      [File.nullFile, 0, DiskEditInternal.dataPageCount]].pointer;    diskLabel ¬ IF ~labels THEN NIL      ELSE Space.Map[        [File.nullFile, 0, DiskEditInternal.labelPageCount]].pointer;    -- Now create the tool with a nice, date stamped, name    String.AppendString[name, "Disk Editor "L];    Version.Append[name];    String.AppendString[name, " of "L];    Time.Append[name, Time.Unpack[bcdTime]];    toolWindow ¬ Tool.Create[      name: name, makeSWsProc: MakeSWs, clientTransition: Transition,      initialState: active];    -- Now that the tool is all created, set up the view swapping subwindow.    -- We let whoever implements the default window export this.    DiskEditInternal.InitializeViewSwappingWindow[];    END;  Init[];  END.LOG4-Sep-81 10:14:09	WDK       LONGify, converted to Tajo 8.1-Mar-82 14:01:18	CAJ    Changed herald to 8.0.13-May-82  9:21:27	AWL         The menu should be permanent.26-Apr-83 10:42:50	EKN      Update to Klamath (and Sierra: use Window.InitializeWindow to set contents of window instead of accessing fields of window yourself) 1-Jul-83 16:54:21	Yien    Removed Menu.SetPNR from procedure ToolCreateSubwindow. Changed herald to 11.0a.15-Jul-83 14:57:29	AWL          Use NIL as default value for ToolCreateSubwindow.display.13-Jan-84 14:24:12	KEK        Add VFM view stuff per JXP   , initialized some variables, 11.0g version stamp. 5-Sep-84 13:51:54	CAJ    Convert to WindowSwap; get header version number via Version.22-Apr-85 16:44:59	CAJ    Transition handles views properly in tiny <=> inactive transition. 4-Jun-86 10:15:12	CAJ    Moved ReplaceFIDString here from private version in DiskEditVFMSW; add ValidateFID and factor out common part from ValidateUID. 5-Sep-86 12:42:57	CAJ    Enable tool to handle either label or no-label operation. 3-Mar-88  8:33:07	CAJ    LONG the POINTERs.  Rip the msg subwindow out of the views menu.