-- Copyright (C) 1984, 1985  by Xerox Corporation. All rights reserved. -- FloppyEditSectorNineSW.mesa	last edited by: ET	21-Apr-87 14:55:42-- This module implements a view, Track 0 Sector 9, for the data display subwindow of the floppy disk editor.DIRECTORY  Floppy USING [FileID, maxCharactersInLabel],  FloppyEditInternal USING [data, heap, Msg, swapWindowKey],  FloppyEditUtilities USING [ReplaceFileIDString, ValidateFileID],  FloppyFormat USING [nullSector, SectorNine],  FormSW USING [    AllocateItemDescriptor, BooleanItem, ClientItemsProcType, CommandItem,    DisplayItem, FilterProcType, line0, line1, line2, line3, line4, line5, line6,    line7, line8, line9, LineN, LongNumberItem, NumberItem, ProcType, TagOnlyItem,    StringEditProc, StringItem],  MsgSW USING [Clear],  String USING [Replace],  Window USING [Handle],  WindowSwap USING [RegisterView];FloppyEditSectorNineSW: PROGRAM  IMPORTS    FloppyEditInternal, FloppyEditUtilities, FormSW, MsgSW, String, WindowSwap =  BEGIN  --//////////////////  -- Local TYPEs, constants, and variables  FormItems: TYPE = {    sectorNine, seal, version, cylinders, tracksPerCylinder, sectorsPerTrack,    fileList, fileListID, fileListSize, rootFile, alternateMicrocode, pilotMicrocode,    diagnosticMicrocode, germ, pilotBootFile, firstAlternateSector,    countBadSectors, nextUnusedFileID, changing, pad, labelSize, label,    sectorOnePadIndex, sectorOnePadValue, next, back};  -- This is the actual contents of sector nine  sectorData: LONG POINTER TO FloppyFormat.SectorNine ¬ NIL;  -- This is data needed to display sector nine, including word-alignment  -- Use Data type when WindowSwap allows giving back storage at unload/shutdown  sectorDisplayData: LONG POINTER TO SectorDisplayData;  SectorDisplayData: TYPE = RECORD [    fileListIDString: LONG STRING ¬ NIL,    rootFileString: LONG STRING ¬ NIL,    changing: BOOLEAN ¬ FALSE,    pad: WORD ¬ 0,    label: LONG STRING ¬ NIL,    sectorOnePadIndex: WORD ¬ 0,    sectorOnePadValue: WORD ¬ 0];  --//////////////////  -- Procedures  Back: FormSW.ProcType =    BEGIN    MsgSW.Clear[FloppyEditInternal.data.msgSW];    IF sectorDisplayData.sectorOnePadIndex IN [0..LENGTH[sectorData.sectorOnePad])      THEN      sectorData.sectorOnePad[sectorDisplayData.sectorOnePadIndex] ¬        sectorDisplayData.sectorOnePadValue;    sectorDisplayData.sectorOnePadIndex ¬      IF sectorDisplayData.sectorOnePadIndex = 0 THEN      LENGTH[sectorData.sectorOnePad] - 1      ELSE sectorDisplayData.sectorOnePadIndex - 1;    sectorDisplayData.sectorOnePadValue ¬ sectorData.sectorOnePad[      sectorDisplayData.sectorOnePadIndex];    FormSW.DisplayItem[sw, FormItems.sectorOnePadIndex.ORD];    FormSW.DisplayItem[sw, FormItems.sectorOnePadValue.ORD];    END;  CleanupSectorNineSW: PROCEDURE =    -- Make data buffer match display.    BEGIN    -- The only things copied here are things which occupy less than a full word    -- in the actual root page; all others are accessed directly.    sectorData.changing ¬ sectorDisplayData.changing;    sectorData.pad ¬ sectorDisplayData.pad;    END;  -- CleanupSectorNineSW  CopyLabel: FormSW.FilterProcType =    BEGIN    FormSW.StringEditProc[sw, item, insert, string];    FOR i: CARDINAL IN [0..MIN[Floppy.maxCharactersInLabel, sectorData.labelSize])      DO sectorData.label[i] ¬ sectorDisplayData.label[i]; ENDLOOP;    END;  -- CopyLabel  DestroySectorNineSW: PROCEDURE =    -- Give back resources when view is going away for good.    BEGIN    String.Replace[@sectorDisplayData.label, NIL, FloppyEditInternal.heap];    String.Replace[      @sectorDisplayData.fileListIDString, NIL, FloppyEditInternal.heap];    String.Replace[      @sectorDisplayData.rootFileString, NIL, FloppyEditInternal.heap];    FloppyEditInternal.heap.FREE[@sectorDisplayData];    sectorDisplayData ¬ NIL;    END;  FillSectorNineSW: PROCEDURE =    -- Make display match data buffer.    BEGIN    -- Only things which do not occupy integral word(s) are copied to local    -- variables.  Everything else just accesses the actual root page.    label: STRING ¬ [Floppy.maxCharactersInLabel];    FloppyEditUtilities.ReplaceFileIDString[      @sectorDisplayData.fileListIDString, sectorData.fileListID];    FloppyEditUtilities.ReplaceFileIDString[      @sectorDisplayData.rootFileString, sectorData.rootFile];    sectorDisplayData.changing ¬ sectorData.changing;    label.length ¬ MIN[sectorData.labelSize, Floppy.maxCharactersInLabel];    FOR i: CARDINAL IN [0..label.length) DO      label[i] ¬ sectorData.label[i]; ENDLOOP;    String.Replace[@sectorDisplayData.label, label, FloppyEditInternal.heap];    sectorDisplayData.sectorOnePadIndex ¬ 0;    sectorDisplayData.sectorOnePadValue ¬ sectorData.sectorOnePad[0];    END;  -- FillSectorNineSW  MakeSectorNineSW: PUBLIC FormSW.ClientItemsProcType =    BEGIN    nItems: CARDINAL = FormItems.LAST.ORD + 1;    sectorData ¬ LOOPHOLE[FloppyEditInternal.data.sectorBuffer];    sectorDisplayData ¬ FloppyEditInternal.heap.NEW[SectorDisplayData];    items ¬ FormSW.AllocateItemDescriptor[nItems];    items[FormItems.sectorNine.ORD] ¬ FormSW.TagOnlyItem[      tag: "SectorNine"L, place: [3, FormSW.line0]];    items[FormItems.seal.ORD] ¬ FormSW.NumberItem[      tag: "Seal "L, place: [148, FormSW.line0], signed: FALSE, notNegative: TRUE,      radix: octal, default: 177777B, value: @sectorData.seal];    items[FormItems.version.ORD] ¬ FormSW.NumberItem[      tag: "Version "L, place: [262, FormSW.line0], signed: FALSE,      notNegative: TRUE, radix: octal, default: 177777B,      value: @sectorData.version];    items[FormItems.cylinders.ORD] ¬ FormSW.NumberItem[      tag: "Cylinders "L, place: [3, FormSW.line1], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorData.cylinders];    items[FormItems.tracksPerCylinder.ORD] ¬ FormSW.NumberItem[      tag: "TracksPerCylinder "L, place: [138, FormSW.line1], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorData.tracksPerCylinder];    items[FormItems.sectorsPerTrack.ORD] ¬ FormSW.NumberItem[      tag: "SectorsPerTrack "L, place: [332, FormSW.line1], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorData.sectorsPerTrack];    items[FormItems.fileList.ORD] ¬ FormSW.NumberItem[      tag: "FileList "L, place: [3, FormSW.line2], signed: FALSE,      notNegative: TRUE, default: FloppyFormat.nullSector,      value: @sectorData.fileList];    items[FormItems.fileListID.ORD] ¬ FormSW.StringItem[      tag: "FileListID "L, inHeap: FALSE, place: [125, FormSW.line2],      string: @sectorDisplayData.fileListIDString,      filterProc: ValidateFileListID];    items[FormItems.fileListSize.ORD] ¬ FormSW.NumberItem[      tag: "FileListSize "L, place: [325, FormSW.line2], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorData.fileListSize];    items[FormItems.rootFile.ORD] ¬ FormSW.StringItem[      tag: "RootFile "L, inHeap: FALSE, place: [3, FormSW.line3],      string: @sectorDisplayData.rootFileString, filterProc: ValidateRootFile];    items[FormItems.alternateMicrocode.ORD] ¬ FormSW.NumberItem[      tag: "alternateMicrocode "L, place: [298, FormSW.line3], signed: FALSE, notNegative: TRUE,      default: 0, value: @sectorData.alternateMicrocode];    items[FormItems.pilotMicrocode.ORD] ¬ FormSW.NumberItem[      tag: "PilotMicrocode "L, place: [3, FormSW.line4], signed: FALSE,      notNegative: TRUE, default: FloppyFormat.nullSector,      value: @sectorData.pilotMicrocode];    items[FormItems.diagnosticMicrocode.ORD] ¬ FormSW.NumberItem[      tag: "DiagnosticMicrocode "L, place: [3, FormSW.line5], signed: FALSE,      notNegative: TRUE, default: FloppyFormat.nullSector,      value: @sectorData.diagnosticMicrocode];    items[FormItems.germ.ORD] ¬ FormSW.NumberItem[      tag: "Germ "L, place: [3, FormSW.line6], signed: FALSE, notNegative: TRUE,      default: FloppyFormat.nullSector, value: @sectorData.germ];    items[FormItems.pilotBootFile.ORD] ¬ FormSW.NumberItem[      tag: "PilotBootFile "L, place: [3, FormSW.line7], signed: FALSE,      notNegative: TRUE, default: FloppyFormat.nullSector,      value: @sectorData.pilotBootFile];    items[FormItems.firstAlternateSector.ORD] ¬ FormSW.NumberItem[      tag: "FirstAlternateSector "L, place: [3, FormSW.line8], signed: FALSE,      notNegative: TRUE, default: FloppyFormat.nullSector,      value: @sectorData.firstAlternateSector];    items[FormItems.countBadSectors.ORD] ¬ FormSW.NumberItem[      tag: "CountBadSectors"L, place: [278, FormSW.line8], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorData.countBadSectors];    items[FormItems.nextUnusedFileID.ORD] ¬ FormSW.LongNumberItem[      tag: "NextUnusedFileID "L, place: [3, FormSW.line9], signed: FALSE,      notNegative: TRUE, default: 1, value: @sectorData.nextUnusedFileID];    items[FormItems.changing.ORD] ¬ FormSW.BooleanItem[      tag: "changing"L, place: [3, FormSW.LineN[10]],      switch: @sectorDisplayData.changing];    items[FormItems.pad.ORD] ¬ FormSW.NumberItem[      tag: "pad "L, place: [135, FormSW.LineN[10]], signed: FALSE,      notNegative: TRUE, radix: octal, default: 0, value: @sectorDisplayData.pad];    items[FormItems.labelSize.ORD] ¬ FormSW.NumberItem[      tag: "Label size "L, place: [3, FormSW.LineN[11]], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorData.labelSize];    items[FormItems.label.ORD] ¬ FormSW.StringItem[      tag: "Label"L, place: [145, FormSW.LineN[11]], inHeap: FALSE,      string: @sectorDisplayData.label, filterProc: CopyLabel];    items[FormItems.sectorOnePadIndex.ORD] ¬ FormSW.NumberItem[      tag: "sectorOnePad index "L, place: [82, FormSW.LineN[12]], signed: FALSE,      notNegative: TRUE, radix: octal, default: 0,      value: @sectorDisplayData.sectorOnePadIndex];    items[FormItems.sectorOnePadValue.ORD] ¬ FormSW.NumberItem[      tag: "value "L, place: [246, FormSW.LineN[12]], signed: FALSE,      notNegative: TRUE, default: 0, value: @sectorDisplayData.sectorOnePadValue];    items[FormItems.next.ORD] ¬ FormSW.CommandItem[      tag: "Next"L, place: [376, FormSW.LineN[12]], proc: Next];    items[FormItems.back.ORD] ¬ FormSW.CommandItem[      tag: "Back"L, place: [418, FormSW.LineN[12]], proc: Back];    RETURN[items, TRUE]    END;  -- MakeSectorNineSW  Next: FormSW.ProcType =    BEGIN    MsgSW.Clear[FloppyEditInternal.data.msgSW];    IF sectorDisplayData.sectorOnePadIndex IN [0..LENGTH[sectorData.sectorOnePad])      THEN      sectorData.sectorOnePad[sectorDisplayData.sectorOnePadIndex] ¬        sectorDisplayData.sectorOnePadValue;    sectorDisplayData.sectorOnePadIndex ¬      (sectorDisplayData.sectorOnePadIndex + 1) MOD LENGTH[        sectorData.sectorOnePad];    sectorDisplayData.sectorOnePadValue ¬ sectorData.sectorOnePad[      sectorDisplayData.sectorOnePadIndex];    FormSW.DisplayItem[sw, FormItems.sectorOnePadIndex.ORD];    FormSW.DisplayItem[sw, FormItems.sectorOnePadValue.ORD];    END;  ValidateFileListID: FormSW.FilterProcType =    BEGIN    valid: BOOLEAN;    id: Floppy.FileID;    FormSW.StringEditProc[sw, item, insert, string];    [valid, id] ¬ FloppyEditUtilities.ValidateFileID[      sectorDisplayData.fileListIDString];    IF ~valid THEN FloppyEditInternal.Msg["Invalid ID"L, TRUE]    ELSE sectorData.fileListID ¬ LOOPHOLE[id];    END;  -- ValidateFileListID  ValidateRootFile: FormSW.FilterProcType =    BEGIN    valid: BOOLEAN;    id: Floppy.FileID;    FormSW.StringEditProc[sw, item, insert, string];    [valid, id] ¬ FloppyEditUtilities.ValidateFileID[      sectorDisplayData.rootFileString];    IF ~valid THEN FloppyEditInternal.Msg["Invalid ID"L, TRUE]    ELSE sectorData.rootFile ¬ LOOPHOLE[id];    END;  -- ValidateRootFile  -- Module initialization:  -- Register this subwindow as an alternate view for the data subwindow  WindowSwap.RegisterView[    key: FloppyEditInternal.swapWindowKey, viewName: "SectorNine"L,    makeFormSW: MakeSectorNineSW, viewFromDataProc: FillSectorNineSW,    dataFromViewProc: CleanupSectorNineSW, destroyViewProc: DestroySectorNineSW];  END.LOG25-Sep-84 16:45:27   CAJ	Created file. 7-Jan-85 16:52:11   CAJ	Move ReplaceFileIDString and ValidateFileID to    FloppyEditUtilities, init sectorData in MakeForm rather than module startup. 7-May-85 13:30:35   CAJ	Get sectorDisplayData from heap rather than global var; add DestroySectorNineSW and return of all storage at deactivate; use default heap in MakeForm.21-Apr-87 14:55:51   ET		Changed fill field to alternateMicrocode to match FloppyFormat.