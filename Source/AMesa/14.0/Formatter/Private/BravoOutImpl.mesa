-- Copyright (C) 1982  by Xerox Corporation. All rights reserved. -- file BravoOutImpl.Mesa, last modified by-- Karlton,	21-Jan-82 20:24:08-- Sweet,	 2-Dec-82 15:31:59DIRECTORY  Ascii USING [ControlZ, CR, SP],  BravoOut USING [OnOff],  Heap USING [systemZone],  Stream USING [Handle, PutChar],  String USING [AppendChar, AppendNumber, SubString];  BravoOutImpl: PROGRAM IMPORTS Heap, Stream, String EXPORTS BravoOut =   BEGIN    outstream: Stream.Handle;    runlength: CARDINAL ¬ 0;  trailer: LONG STRING ¬ NIL;  currentfont: CARDINAL;  bold, italic: BravoOut.OnOff;  boldChar: ARRAY BravoOut.OnOff OF CHARACTER = ['b, 'B];  italicChar: ARRAY BravoOut.OnOff OF CHARACTER = ['i, 'I];    Start: PUBLIC PROCEDURE [stream: Stream.Handle] =    BEGIN    bold ¬ italic ¬ off;    currentfont ¬ 0;    outstream ¬ stream;    runlength ¬ 0;    IF trailer = NIL THEN       trailer ¬ Heap.systemZone.NEW[StringBody[500]]     ELSE trailer.length ¬ 0;    END;      Done: PUBLIC PROCEDURE = {    IF runlength # 0 THEN CloseParagraph[];    Heap.systemZone.FREE[@trailer]};    SubString: PUBLIC PROCEDURE [ss: String.SubString] =    BEGIN    i: CARDINAL;    FOR i IN [ss.offset..ss.offset+ss.length) DO      Stream.PutChar[outstream, ss.base[i]];      ENDLOOP;    runlength ¬ runlength + ss.length;    END;      SetBold: PUBLIC PROCEDURE [onoff: BravoOut.OnOff] =    BEGIN    IF onoff # bold THEN      BEGIN      bold ¬ onoff;      IF runlength # 0 THEN AppendTrailerNumber[runlength];      runlength ¬ 0;      String.AppendChar[trailer, boldChar[bold]];      END;    END;      SetItalics: PUBLIC PROCEDURE [onoff: BravoOut.OnOff] =    BEGIN    IF onoff # italic THEN      BEGIN      italic ¬ onoff;      IF runlength # 0 THEN AppendTrailerNumber[runlength];      runlength ¬ 0;      String.AppendChar[trailer, italicChar[italic]];      END;    END;      Text: PUBLIC PROCEDURE [str: LONG STRING] =    BEGIN    i: CARDINAL;    FOR i IN [0..str.length) DO      Stream.PutChar[outstream, str[i]];      ENDLOOP;    runlength ¬ runlength+str.length;    END;      Char: PUBLIC PROCEDURE [ch: CHARACTER] = {    Stream.PutChar[outstream, ch]; runlength ¬ runlength+1};      CR: PUBLIC PROCEDURE =    BEGIN    IF trailer.length > 450 THEN CloseParagraph[]    ELSE {Stream.PutChar[outstream, Ascii.CR]; runlength ¬ runlength+1};    END;      AppendTrailerNumber: PROCEDURE [n: CARDINAL] =    BEGIN    l: INTEGER ¬ trailer.length-1;    IF l>=0 AND trailer[l] IN ['0..'9] THEN      String.AppendChar[trailer, Ascii.SP];    String.AppendNumber[trailer, n, 10];    END;      SetFont: PUBLIC PROCEDURE [font: CARDINAL] =    BEGIN    IF font = currentfont THEN RETURN;    IF runlength # 0 THEN AppendTrailerNumber[runlength];    runlength ¬ 0;    currentfont ¬ font;    String.AppendChar[trailer,'f];    String.AppendChar[trailer, '0+font];    END;      CloseParagraph: PUBLIC PROCEDURE =    BEGIN    i: CARDINAL;    Stream.PutChar[outstream, Ascii.ControlZ];    IF trailer.length > 0 THEN      BEGIN Stream.PutChar[outstream, '\\];       FOR i IN [0..trailer.length) DO	Stream.PutChar[outstream, trailer[i]];	ENDLOOP;      END;    Stream.PutChar[outstream, Ascii.CR];    runlength ¬ 0;    trailer.length ¬ 0;    IF bold = on THEN BEGIN bold ¬ off; SetBold[on]; END;    IF italic = on THEN BEGIN italic ¬ off; SetItalics[on]; END;    IF currentfont # 0 THEN      BEGIN old: CARDINAL = currentfont; currentfont ¬ 0; SetFont[old]; END;    END;      END.    