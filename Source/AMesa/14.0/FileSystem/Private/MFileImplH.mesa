-- Copyright (C) 1983  by Xerox Corporation. All rights reserved. -- File: MFileImplH.mesa - last edited by-- LXR    ,	18-May-83 10:43:55-- PXK    ,	17-Jun-83 14:23:38DIRECTORY  File USING [ID],  Environment USING [wordsPerPage],  Inline USING [LongCOPY, LongCOPYReverse],  MConvertLP USING [InOldFormat, OldFileID, oldLeaderVersionID],  MFileOps USING [LeaderPage, leaderVersionID];MFileImplH: PROGRAM IMPORTS MConvertLP, Inline EXPORTS MConvertLP =  BEGIN  OldFileID: TYPE = MConvertLP.OldFileID;  oldIdSize: CARDINAL = SIZE[OldFileID];  newIdSize: CARDINAL = SIZE[File.ID];  sizeDelta: CARDINAL = oldIdSize - newIdSize;  skipped: CARDINAL = SIZE[CARDINAL] + newIdSize;    -- these words are not moved since they are overwritten explicitly anyway  wpp: CARDINAL = Environment.wordsPerPage;    LeaderPageTooLong: PUBLIC ERROR = CODE;  WrongVersion: PUBLIC ERROR = CODE;  << the difference between the Sierra and Klamath leader page formats is that   the dir field of the leader page is two words long in Klamath but 5 words   long in Sierra. >>  ConvertToNewFormat: PUBLIC PROCEDURE [lp: MFileOps.LeaderPage, newID: File.ID]    RETURNS [oldID: OldFileID] =    BEGIN    IF ~MConvertLP.InOldFormat[lp] THEN ERROR WrongVersion;     Inline.LongCOPY[from: @lp.fp.dir, to: @oldID, nwords: oldIdSize];    Inline.LongCOPY[      from: lp + skipped + sizeDelta,      to: lp + skipped,      nwords: wpp - skipped - sizeDelta];    LOOPHOLE[      lp + wpp - sizeDelta,      LONG POINTER TO ARRAY [0..sizeDelta) OF CARDINAL]­ ¬ ALL[0];    lp.fp.freeWords ¬ lp.fp.freeWords + sizeDelta;    lp.fp.versionID ¬ MFileOps.leaderVersionID;    lp.fp.dir ¬ newID;    END;    ConvertToOldFormat: PUBLIC PROCEDURE [lp: MFileOps.LeaderPage, oldID: OldFileID]    RETURNS [newID: File.ID] =    BEGIN    IF lp.fp.versionID # MFileOps.leaderVersionID THEN ERROR WrongVersion;     IF lp.fp.freeWords < sizeDelta THEN ERROR LeaderPageTooLong;    lp.fp.freeWords ¬ lp.fp.freeWords - sizeDelta;    newID ¬ lp.fp.dir;    Inline.LongCOPYReverse[      from: lp + skipped,      to: lp + skipped + sizeDelta,      nwords: wpp - skipped - sizeDelta];    Inline.LongCOPY[from: @oldID, to: @lp.fp.dir, nwords: oldIdSize];    lp.fp.versionID ¬ MConvertLP.oldLeaderVersionID;    END;        END.