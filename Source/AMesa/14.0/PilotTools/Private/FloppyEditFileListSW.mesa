-- Copyright (C) 1985, 1988  by Xerox Corporation. All rights reserved. -- FloppyEditFileListSW.mesa	last edited by: CAJ	 2-Mar-88  9:26:35-- This module implements a Floppy File System File List view for the data-- display subwindow of the floppy disk editor.DIRECTORY  Environment USING [wordsPerPage],  Floppy USING [FileID],  FloppyEditInternal USING [data, heap, Msg, swapWindowKey],  FloppyEditUtilities USING [ReplaceFileIDString, ValidateFileID],  FloppyFormat USING [FileList, FileListEntry],  FormSW USING [    AllocateItemDescriptor, ClientItemsProcType, FilterProcType, FindIndex,    line0, line1, nextLine, NumberItem, sameLine, StringEditProc, StringItem,    TagOnlyItem],  String USING [Replace],  WindowSwap USING [RegisterView];FloppyEditFileListSW: PROGRAM  IMPORTS FloppyEditInternal, FloppyEditUtilities, FormSW, String, WindowSwap =  BEGIN    --//////////////////  -- Local TYPEs, constants, and variables  FileStrings: TYPE = ARRAY [0..maxFiles) OF LONG STRING;  FormItems: TYPE = {fileList, seal, version, entryCount, maxEntries, filesBase};  idStringSize: CARDINAL = 24;  -- make this a tool-wide constant  itemsPerFileEntry: CARDINAL = 4;  maxFiles: CARDINAL =    (Environment.wordsPerPage - 4)/SIZE[FloppyFormat.FileListEntry];    -- magic 4 is FileList overhead  -- This is the actual data contents of the sector  sectorData: LONG POINTER TO FloppyFormat.FileList ¬ NIL;  fileStrings: LONG POINTER TO FileStrings ¬ NIL;  --//////////////////  -- Procedures  CleanupFileListSW: PROCEDURE =    -- Make data buffer match display.    {};  DestroyFileListSW: PROCEDURE =    -- Give back resources when view is going away for good.    BEGIN    FOR i: CARDINAL IN [0..maxFiles) DO      String.Replace[@fileStrings[i], NIL, FloppyEditInternal.heap];      ENDLOOP;    FloppyEditInternal.heap.FREE[@fileStrings];    fileStrings ¬ NIL;    END;  FillFileListSW: PROCEDURE =    -- Make display match data buffer.    BEGIN    FOR i: CARDINAL IN [0..maxFiles) DO      FloppyEditUtilities.ReplaceFileIDString[        @fileStrings[i], sectorData.files[i].file];      ENDLOOP;    END;  MakeFileListSW: FormSW.ClientItemsProcType =    BEGIN    nItems: CARDINAL = FormItems.filesBase.ORD + (maxFiles * itemsPerFileEntry);    items ¬ FormSW.AllocateItemDescriptor[nItems];    sectorData ¬ LOOPHOLE[FloppyEditInternal.data.sectorBuffer];    fileStrings ¬ FloppyEditInternal.heap.NEW[FileStrings];    items[FormItems.fileList.ORD] ¬ FormSW.TagOnlyItem[      tag: "File List"L, place: [4, FormSW.line0]];    items[FormItems.seal.ORD] ¬ FormSW.NumberItem[      tag: "Seal "L, place: [191, FormSW.line0], signed: FALSE, notNegative: TRUE,      radix: octal, value: @sectorData.seal];    items[FormItems.version.ORD] ¬ FormSW.NumberItem[      tag: "Version "L, place: [309, FormSW.line0], signed: FALSE,      notNegative: TRUE, radix: octal, value: @sectorData.version];    items[FormItems.entryCount.ORD] ¬ FormSW.NumberItem[      tag: "Entry Count "L, place: [4, FormSW.line1], signed: FALSE,      notNegative: TRUE, value: @sectorData.count];    items[FormItems.maxEntries.ORD] ¬ FormSW.NumberItem[      tag: "Max Entries "L, place: [173, FormSW.line1], signed: FALSE,      notNegative: TRUE, value: @sectorData.maxEntries];    FOR i: CARDINAL IN [0..maxFiles) DO      j: CARDINAL ¬ i * itemsPerFileEntry + FormItems.filesBase.ORD;      fileStrings[i] ¬ FloppyEditInternal.heap.NEW[StringBody[idStringSize]];      items[j] ¬ FormSW.StringItem[        tag: "ID"L, inHeap: FALSE, string: @fileStrings[i],        place: [4, FormSW.nextLine], filterProc: ValidateFileID];      items[j+1] ¬ FormSW.NumberItem[        tag: "Type "L, place: [139, FormSW.sameLine], signed: FALSE,        notNegative: TRUE, radix: octal, value: @sectorData.files[i].type];      items[j+2] ¬ FormSW.NumberItem[        tag: "Location "L, place: [243, FormSW.sameLine], signed: FALSE,        notNegative: TRUE, radix: octal, value: @sectorData.files[i].location];      items[j+3] ¬ FormSW.NumberItem[        tag: "Size "L, place: [399, FormSW.sameLine], signed: FALSE,        notNegative: TRUE, radix: octal, value: @sectorData.files[i].size];      ENDLOOP;    RETURN[items: items, freeDesc: TRUE];    END;  ValidateFileID: FormSW.FilterProcType =    BEGIN    valid: BOOLEAN;    id: Floppy.FileID;    i: CARDINAL ¬      (FormSW.FindIndex[sw: sw, item: item] - FormItems.filesBase.ORD)        /itemsPerFileEntry;    FormSW.StringEditProc[sw, item, insert, string];    [valid, id] ¬ FloppyEditUtilities.ValidateFileID[fileStrings[i]];    IF ~valid THEN FloppyEditInternal.Msg["Invalid ID"L, TRUE]    ELSE sectorData.files[i].file ¬ LOOPHOLE[id];    END;  -- ValidateFileID  -- Module initialization:  -- Register this subwindow as an alternate view for the data subwindow  WindowSwap.RegisterView[    key: FloppyEditInternal.swapWindowKey, viewName: "FileList"L,    makeFormSW: MakeFileListSW, viewFromDataProc: FillFileListSW,    dataFromViewProc: CleanupFileListSW, destroyViewProc: DestroyFileListSW];  END.LOG11-Dec-85  9:22:44   CAJ	Created file. 2-Mar-88  9:25:30   CAJ	StringItem inHeap ¬ FALSE.