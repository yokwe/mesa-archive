-- Copyright (C) 1981, 1983  by Xerox Corporation. All rights reserved. -- File: MailFileOps.mesa  Last edit by-- PXK    ,	22-Sep-83 17:18:18-- JGS    ,	26-Feb-81 14:19:28-- RXJ     ,	29-Oct-81  8:05:57DIRECTORY  Ascii USING [SP],  BodyDefs USING [ItemType],  MailFile USING [AttributeIndex, Attributes, ClassIndex, Flag, LetGo, MsgNumber],  MStream USING [PleaseReleaseProc],  Stream USING [Handle],  System USING [gmtEpoch, GreenwichMeanTime];  MailFileOps: DEFINITIONS =  BEGIN    -- TYPEs  Handle: TYPE = LONG POINTER TO Object;  Object: TYPE = MONITORED RECORD [    stream, tocStream: Stream.Handle ¬ NIL,    beingFreed: BOOLEAN ¬ FALSE,    writeEnabled: BOOLEAN ¬ FALSE,    fileName: LONG STRING ¬ NIL,    letGo: MailFile.LetGo ¬ NIL,    data: LONG POINTER TO UNSPECIFIED ¬ NIL,    header: TocHeader ¬ NIL,    info: LONG POINTER TO InfoSequence ¬ NIL];      AttributeSideAffect: TYPE = {null, delete, undelete, mark, unmark};  classChars: CARDINAL = 256;  ClassChars: TYPE = PACKED ARRAY [0..classChars) OF CHARACTER;  noClass: ClassNameDescriptor = [0, 0];  Classes: TYPE = ARRAY MailFile.ClassIndex OF ClassNameDescriptor;  ClassNameDescriptor: TYPE = RECORD [    start: [0..256),    end: [0..256)];    classLength: CARDINAL = 512;  standardStampLength: CARDINAL = 24;  wholeStampLength: CARDINAL = attributesItemLength + standardStampLength + 2;        -- @....@  initialAttributes: MailFile.Attributes = ALL[FALSE];  itemOverhead: CARDINAL = 12; -- "00000 00000 ".length  attributesLength: CARDINAL = MailFile.AttributeIndex.LAST.ORD.SUCC + 1;     -- extra one for CR  attributesItemLength: CARDINAL = attributesLength + itemOverhead;  tocVersion: CARDINAL = 25053; -- ddmmy    TocHeader: TYPE = LONG POINTER TO TocHeaderObject;  TocHeaderObject: TYPE = MACHINE DEPENDENT RECORD [ -- this object is pickled    version1(0): CARDINAL ¬ tocVersion,    parentTime(1): System.GreenwichMeanTime,    parsedLength(3): LONG CARDINAL ¬ 0,    hasClasses(5:0..0): BOOLEAN ¬ FALSE,    dirty(5:1..1): BOOLEAN ¬ FALSE,    pad(5:2..15): [0..37777B] ¬ 0,    classPos(6): LONG CARDINAL ¬ 0,    classLength(8): CARDINAL ¬ 0,    classes(9): Classes ¬ ALL[noClass],    infoStart(33): LONG CARDINAL ¬ 0,    infoBytes(35): CARDINAL ¬ 0,    classChars(36): ClassChars ¬ ALL[0C],    version2(164): CARDINAL ¬ tocVersion,    infoMax(165): MailFile.MsgNumber ¬ 90];  headerBytes: CARDINAL = SIZE[TocHeaderObject]*2;      infoStamp: CARDINAL = 177401B;  InfoSequence: TYPE = RECORD [    stamp: CARDINAL ¬ infoStamp,    length: MailFile.MsgNumber ¬ 0,    info: SEQUENCE maxLength: MailFile.MsgNumber OF Info];  Info: TYPE = MACHINE DEPENDENT RECORD [    pos(0): LONG CARDINAL ¬ 0,    length(2): CARDINAL ¬ 0,    tocPos(3): LONG CARDINAL ¬ 0,    tocLength(5:0..7): [0..255] ¬ 0,    flag(5:8..15): CHARACTER ¬ Ascii.SP,    stampLength(6): CARDINAL ¬ 0,    date(7): System.GreenwichMeanTime ¬ System.gmtEpoch,    attributes(9): MailFile.Attributes ¬ ALL[FALSE]];    msgAttributes: BodyDefs.ItemType = VAL[3000B];  msgClasses: BodyDefs.ItemType = VAL[3001B];    deleteFlag: MailFile.Flag = 'D;  undeleteFlag: MailFile.Flag = 'U;  examinedFlag: MailFile.Flag = 'S;  unexaminedFlag: MailFile.Flag = 'U;    -- public variables and procedures    -- from MailFileImplA    starStampStar: READONLY LONG STRING;  z: UNCOUNTED ZONE;    BadFormat: ERROR [msg: MailFile.MsgNumber, pos: LONG CARDINAL];  ReleaseMailStream: MStream.PleaseReleaseProc;  -- from MailFileImplB    DestroyToc: PROC [h: Handle];  LoadToc: PROC [h: Handle, bodyName: LONG STRING];    ExtendToc: PROC [h: Handle, before: MailFile.MsgNumber];  -- leaves header dirty  DirtyToc: PROC [h: Handle];   -- header is now marked dirty  CleanupToc: PROC [h: Handle]; -- header is now marked clean    ReadOnlyToc: PROC [h: Handle];  WriteToc: PROC [h: Handle];    -- from MailFileImplC    PutClasses: PROC [h: Handle];  ParseClasses: PROC [h: Handle, length: CARDINAL];    END.