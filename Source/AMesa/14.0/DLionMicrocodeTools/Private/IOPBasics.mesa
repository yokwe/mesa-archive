-- Copyright (C) 1982  by Xerox Corporation. All rights reserved. -- IOPBasics.mesa, HGM, 26-Jun-82 18:14:52DIRECTORY  Environment USING [Byte],  Inline USING [BITAND],    IOP USING [Instruction, InstructionLength, JumpTarget];IOPBasics: PROGRAM  IMPORTS Inline  EXPORTS IOP =  BEGIN  UnimplimentedInstruction: PUBLIC ERROR = CODE;    LengthOfInstruction: PUBLIC PROCEDURE [operation: Environment.Byte] RETURNS [IOP.InstructionLength] =    BEGIN    SELECT operation FROM  -- Sorted by occurrence in MCS-85 Users Guide      -- Data Transfer Group          100B, 101B, 102B, 103B, 104B, 105B, 107B => RETURN[1];  -- MOV B,r      110B, 111B, 112B, 113B, 114B, 115B, 117B => RETURN[1];  -- MOV C,r      120B, 121B, 122B, 123B, 124B, 125B, 127B => RETURN[1];  -- MOV D,r      130B, 131B, 132B, 133B, 134B, 135B, 137B => RETURN[1];  -- MOV E,r      140B, 141B, 142B, 143B, 144B, 145B, 147B => RETURN[1];  -- MOV H,r      150B, 151B, 152B, 153B, 154B, 155B, 157B => RETURN[1];  -- MOV L,r      170B, 171B, 172B, 173B, 174B, 175B, 177B => RETURN[1];  -- MOV A,r            106B, 116B, 126B, 136B, 146B, 156B, 176B => RETURN[1];  -- MOV r,M      160B, 161B, 162B, 163B, 164B, 165B, 167B => RETURN[1];  -- MOV M,r      006B, 016B, 026B, 036B, 046B, 056B, 076B => RETURN[2];  -- MVI r,byte      066B => RETURN[2];  -- MVI M,byte            001B, 021B, 041B, 061B => RETURN[3];  -- LXI p,word      072B => RETURN[3];  -- LDA word­      062B => RETURN[3];  -- STA word­      052B => RETURN[3];  -- LHLD word­      042B => RETURN[3];  -- SHLD word­      012B, 032B => RETURN[1];  -- LDAX p­      002B, 022B => RETURN[1];  -- STAX p­      353B => RETURN[1];  -- XCHG            -- Arithmetic Group            200B, 201B, 202B, 203B, 204B, 205B, 207B => RETURN[1];  -- ADD r      206B => RETURN[1];  -- ADD M      306B => RETURN[2];  -- ADI byte            210B, 211B, 212B, 213B, 214B, 215B, 217B => RETURN[1];  -- ADC r      216B => RETURN[1];  -- ADC M      316B => RETURN[2];  -- ACI byte      220B, 221B, 222B, 223B, 224B, 225B, 227B => RETURN[1];  -- SUB r      226B => RETURN[1];  -- SUB M      326B => RETURN[2];  -- SUI byte            230B, 231B, 232B, 233B, 234B, 235B, 237B => RETURN[1];  -- SBB r      236B => RETURN[1];  -- SBB M      336B => RETURN[2];  -- SBI byte       004B, 014B, 024B, 034B, 044B, 054B, 074B => RETURN[1];  -- INR r      064B => RETURN[1];  -- INR M      005B, 015B, 025B, 035B, 045B, 055B, 075B => RETURN[1];  -- DCR r      065B => RETURN[1];  -- DCR M      003B, 023B, 043B, 063B => RETURN[1];  -- INX p      013B, 033B, 053B, 073B => RETURN[1];  -- DCX p      011B, 031B, 051B, 071B => RETURN[1];  -- DAD p      047B => RETURN[1];  -- DAA            -- Logical Group            240B, 241B, 242B, 243B, 244B, 245B, 247B => RETURN[1];  -- ANA r      246B => RETURN[1];  -- ANA M      346B => RETURN[2];  -- ANI byte      250B, 251B, 252B, 253B, 254B, 255B, 257B => RETURN[1];  -- XRA r      256B => RETURN[1];  -- XRA M      356B => RETURN[2];  -- XRI byte      260B, 261B, 262B, 263B, 264B, 265B, 267B => RETURN[1];  -- ORA r      266B => RETURN[1];  -- ORA M      366B => RETURN[2];  -- ORI byte      270B, 271B, 272B, 273B, 274B, 275B, 277B => RETURN[1];  -- CMP r      276B => RETURN[1];  -- CMP M      376B => RETURN[2];  -- CPI byte            007B => RETURN[1];  -- RLC      017B => RETURN[1];  -- RRC      027B => RETURN[1];  -- RAL      037B => RETURN[1];  -- RAR      057B => RETURN[1];  -- CMA      077B => RETURN[1];  -- CMC      067B => RETURN[1];  -- STC            -- Branch Group      303B => RETURN[3];  -- JMP      302B, 312B, 322B, 332B, 342B, 352B, 362B, 372B => RETURN[3];  -- Jx            315B => RETURN[3];  -- CALL      304B, 314B, 324B, 334B, 344B, 354B, 364B, 374B => RETURN[3];  -- Cx            311B => RETURN[1];  -- RET      300B, 310B, 320B, 330B, 340B, 350B, 360B, 370B => RETURN[1];  -- Rx            307B, 317B, 327B, 337B, 347B, 357B, 367B, 377B => RETURN[1];  -- RST n            351B => RETURN[1];  -- PCHL            -- Stack, I/O, and Machine Control Group            305B, 325B, 345B => RETURN[1];  -- PUSH p      365B => RETURN[1];  -- PUSH PSW            301B, 321B, 341B => RETURN[1];  -- POP p      361B => RETURN[1];  -- POP PSW             343B => RETURN[1];  -- XTHL      371B => RETURN[1];  -- SPHL             333B => RETURN[2];  -- IN port      323B => RETURN[2];  -- OUT port            373B => RETURN[1];  -- EI      363B => RETURN[1];  -- DI            166B => RETURN[1];  -- HLT            000B => RETURN[1];  -- NOP            040B => RETURN[1];  -- RIM      060B => RETURN[1];  -- SIM            010B, 020B, 030B, 050B, 070B,      313B, 331B, 335B, 355B, 375B => ERROR UnimplimentedInstruction;            ENDCASE => ERROR;    END;       MightJump: PUBLIC PROCEDURE [instruction: IOP.Instruction] RETURNS [BOOLEAN] =    BEGIN    SELECT instruction.operation FROM      300B, 310B, 320B, 330B, 340B, 350B, 360B, 370B => RETURN[TRUE];  -- RETx      302B, 312B, 322B, 332B, 342B, 352B, 362B, 372B => RETURN[TRUE];  -- Jx      304B, 314B, 324B, 334B, 344B, 354B, 364B, 374B => RETURN[TRUE];  -- CALLx      307B, 317B, 327B, 337B, 347B, 357B, 367B, 377B => RETURN[TRUE];  -- RSTn      303B => RETURN[TRUE];  -- JMP      311B => RETURN[TRUE];  -- RET      315B => RETURN[TRUE];  -- CALL      351B => RETURN[TRUE];  -- PCHL      ENDCASE => RETURN[FALSE];    END;        JumpAddress: PUBLIC PROCEDURE [instruction: IOP.Instruction] RETURNS [IOP.JumpTarget] =    BEGIN    SELECT instruction.operation FROM      302B, 312B, 322B, 332B, 342B, 352B, 362B, 372B,  -- Jx      304B, 314B, 324B, 334B, 344B, 354B, 364B, 374B,  -- CALLx      303B,  -- JMP      315B =>  -- CALL        BEGIN  -- Bytes stored backwards        RETURN[[jumps[instruction.byte3*256 + instruction.byte2]]];	END;      300B, 310B, 320B, 330B, 340B, 350B, 360B, 370B,  -- RETx      311B => RETURN[[tos[]]];	 -- RET      307B, 317B, 327B, 337B, 347B, 357B, 367B, 377B =>  -- RSTn        BEGIN	RETURN[[jumps[Inline.BITAND[instruction.operation, 70B]]]];	END;      351B => RETURN[[hl[]]];  -- PCHL      ENDCASE => RETURN[[next[]]];    END;      END.