-- Copyright (C) 1983  by Xerox Corporation. All rights reserved. -- TestControl.mesa (last edited by: JXP    on: 17-Aug-83 14:55:52)-- Note that this turkey supports three modes of operation:--   a) where it Pilot tests can create lots of windows.  In this case--      there is a prinicpal window for PilotTests, and seperate windows--      for other interesting tests.--   b) where there is a single window and no exec.  This is the situation where--      there is a special PilotTests bootfile.--   c) where there is a single window and an exec.  Here we have to share the--      exec's window.DIRECTORY  Command USING [    Aborted, Action, Comment, Confirm, InstallTopLevel, QuitLevel, RunTopLevel,    UnwindCmd, WriteError],  Exec USING [    AddCommand, ExecProc, GetTTY, ReleaseTTY],  PilotCommand,  Process USING [Detach],  Runtime USING [CallDebugger, GetBcdTime, IsBound],  Tool USING [UnusedLogName],  TTY USING [Handle, Create, Destroy, OutOfInstances, PutCR, PutDate, PutString];TestControl: PROGRAM  IMPORTS Command, Exec, Process, Runtime, Tool, TTY  EXPORTS PilotCommand =  BEGIN  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -- Commands supported by this module  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  InstallTopLevelCommands: PROC = {    Command.InstallTopLevel[defaultWindow, ["copilot", CoPilotCmd]];    Command.InstallTopLevel[defaultWindow, ["--",      Command.Comment]];    Command.InstallTopLevel[defaultWindow, ["quit",    Command.QuitLevel]];    Command.InstallTopLevel[defaultWindow, ["unwind",  Command.UnwindCmd]]};  CoPilotCmd: Command.Action = {    Command.Confirm[h]; Runtime.CallDebugger["Proceed to return to test package."L]};    -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -- default public tty window  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  defaultWindow: PUBLIC TTY.Handle;  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -- support for cases a&b listed above.  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  RunTopLevel: PROCEDURE =    BEGIN    Command.RunTopLevel[      defaultWindow !      ABORTED => {        Command.WriteError[defaultWindow, "Process.Aborted"L];        ERROR Command.Aborted}];    TTY.Destroy[defaultWindow];    END;  InitWindow: PROCEDURE =    BEGIN    debugUnderExec: BOOLEAN ¬ FALSE;    logName:        STRING ¬ [60];    IF debugUnderExec THEN TTY.OutOfInstances;    IF Runtime.IsBound[LOOPHOLE[Tool.UnusedLogName]] THEN      Tool.UnusedLogName[unused: logName, root:"PilotTests.log"L]    ELSE logName ¬ "PilotTests.log"L;    defaultWindow ¬ TTY.Create[name: logName];    TTY.PutString[defaultWindow, "Pilot Tests of "L];    InstallTopLevelCommands[];    TTY.PutDate[defaultWindow, Runtime.GetBcdTime[]];    TTY.PutCR[defaultWindow];    Process.Detach[FORK RunTopLevel]    END;  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -- support for case c listed above.  -- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  first: BOOLEAN ¬ TRUE;  WindowChangedUnderMe: ERROR = CODE;  Main: Exec.ExecProc =     BEGIN    ttyH: TTY.Handle = Exec.GetTTY[h];    IF first THEN {defaultWindow ¬ ttyH; InstallTopLevelCommands[]}    ELSE IF ttyH#defaultWindow THEN ERROR WindowChangedUnderMe;    first ¬ FALSE;    Command.RunTopLevel[defaultWindow    ! ABORTED => {        Command.WriteError[defaultWindow, "Process.Aborted"L];        ERROR Command.Aborted};      UNWIND => Exec.ReleaseTTY[ttyH]];    Exec.ReleaseTTY[ttyH];    END;      -- MAINLINE PROGRAM  InitWindow[  ! TTY.OutOfInstances => {Exec.AddCommand["PilotTests.~"L, Main]; CONTINUE}];  END....LOGTime: April 24, 1980  11:14 AM	By: VYS     	Action: Remove references to RS232CTestControl and RS232CMgrTestControl.  RS232CTest and RS232CMgrTest are no longer part of PilotTests.Time: June 10, 1980  9:54 AM	By: MXA    	Action: Remove references to Mark2Commands, D1750Commands.  Mark2Test and D1750Test run in their own windows under Tajo.Time: June 24, 1980  10:07 AM	By: FXH    	Action: Modify to allow starting of tests via the multiple control module feature of configs.Time: August 18, 1980  11:01 AM	By: SXY   	Action: Command and TeletypeWindowDefs are replaced by TTYCommand and TTY respectively. Add DefaultWindow.Time: August 20, 1980  10:59 AM	By: SXY    Action: Added three invocations of InstallTopLevelTime: August 27, 1980  1:59 PM	By: SXY    Action: Modify the Procedure call TTY.Create corresponding to the newest version of TTYTime: September 9, 1980  3:45 PM	By: SXY    Action: Modified according to new Command.Action with handle as a parameterTime: March 1, 1981  12:54 PM	By: AWL       Action: Changed date of PilotTestsTime: 30-Nov-81 14:26:54	By: CAJ  Action: Create log name using Tool.UnusedLogName.Time: 20-Jan-82 14:24:10	By: CAJ  Action: Added .log to logname.Time: 24-Feb-82 11:32:28	By: FXH     Action: added junk to support case c) mentioned in header, i.e. running under the exec.Time: 25-Jan-83 14:47:46	By: RXJ      Action: New Exec Interface.Time: 17-Aug-83 14:56:00	By: JXP    Action: Convert to 11.0b.